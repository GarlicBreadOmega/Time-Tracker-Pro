<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timesheet Tracker Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js for advanced charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // App Version
        const APP_VERSION = '2.0.0';

        // Icons (keeping all existing icons and adding new ones)
        const Plus = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Calendar = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const Users = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const Settings = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        );

        const Play = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
        );

        const Stop = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            </svg>
        );

        const Pause = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
        );

        const Clock = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        );

        const Coffee = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
                <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
                <line x1="6" y1="1" x2="6" y2="4"></line>
                <line x1="10" y1="1" x2="10" y2="4"></line>
                <line x1="14" y1="1" x2="14" y2="4"></line>
            </svg>
        );

        const Copy = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        );

        const Tag = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                <line x1="7" y1="7" x2="7.01" y2="7"></line>
            </svg>
        );

        const AlertTriangle = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        );

        const Check = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        );

        const Archive = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="21 8 21 21 3 21 3 8"></polyline>
                <rect x="1" y="3" width="22" height="5"></rect>
                <line x1="10" y1="12" x2="14" y2="12"></line>
            </svg>
        );

        const RefreshCw = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        );

        const ChevronDown = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        );

        const ChevronUp = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="18 15 12 9 6 15"></polyline>
            </svg>
        );

        const HelpCircle = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        );

        const Paperclip = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
            </svg>
        );

        const Filter = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
        );

        const PieChart = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
            </svg>
        );

        // ... (keep all other existing icons: Lock, Unlock, Trash2, Download, Upload, Search, BarChart, Moon, Sun, Bell, Undo, Redo, FileText, StickyNote, X, Folder)

        const Lock = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        );

        const Unlock = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
            </svg>
        );

        const Trash2 = ({ size = 18 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const Download = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const Upload = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );

        const Search = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        );

        const BarChart = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
        );

        const Moon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        );

        const Sun = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
        );

        const Bell = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
        );

        const Undo = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 7v6h6"></path>
                <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"></path>
            </svg>
        );

        const Redo = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 7v6h-6"></path>
                <path d="M3 17a9 9 0 019-9 9 9 0 016 2.3l3 2.7"></path>
            </svg>
        );

        const FileText = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
        );

        const StickyNote = ({ size = 16 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7l-5-5z"></path>
                <line x1="9" y1="9" x2="15" y2="9"></line>
                <line x1="9" y1="13" x2="15" y2="13"></line>
                <line x1="9" y1="17" x2="13" y2="17"></line>
            </svg>
        );

        const X = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const Folder = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
        );

        const DEFAULT_CUSTOMIZATION = {
            theme: 'default',
            defaultReminderDuration: 60,
            autoSave: true,
            timeFormat: '24h',
            dateFormat: 'YYYY-MM-DD',
            firstDayOfWeek: 'monday',
            defaultView: 'dashboard',
            weeklyHourGoal: 40,
            enableTooltips: true,
            confirmDeletions: true,
            highlightTimer: true,
            autoStopTimer: false,
            autoStopHours: 8,
            idleDetection: false,
            idleThresholdMinutes: 15,
            breakReminderEnabled: false,
            breakReminderMinutes: 60,
            sessionTimeout: false,
            sessionTimeoutMinutes: 30,
            compactView: false,
            itemsPerPage: 25,
            fiscalYearStart: '01-01'
        };

        // Data version for migrations
        const DATA_VERSION = 2;

        // Toast notification component for confirmation messages (Issue 102)
        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            return (
                <div className={`fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50 animate-slide-up`}>
                    {type === 'success' && <Check size={20} />}
                    {type === 'error' && <AlertTriangle size={20} />}
                    <span>{message}</span>
                </div>
            );
        };

        // Error Boundary component (Issue 103)
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('Error caught by boundary:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-gray-100 p-6">
                            <div className="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
                                <AlertTriangle size={48} className="mx-auto text-red-500 mb-4" />
                                <h2 className="text-2xl font-bold mb-2">Something went wrong</h2>
                                <p className="text-gray-600 mb-4">An unexpected error occurred. Please try refreshing the page.</p>
                                <button
                                    onClick={() => window.location.reload()}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg"
                                >
                                    Refresh Page
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        function TimesheetTracker() {
            const [entries, setEntries] = useState([]);
            const [clients, setClients] = useState([]);
            const [archivedClients, setArchivedClients] = useState([]); // Issue 32: Client Archive
            const [tags, setTags] = useState([]); // Issue 21: Entry Tags
            const [templates, setTemplates] = useState([]); // Issue 17: Entry Templates
            const [savedFilters, setSavedFilters] = useState([]); // Issue 43: Saved Filters
            const [searchHistory, setSearchHistory] = useState([]); // Issue 45: Search History
            const [clientGroups, setClientGroups] = useState([]); // Issue 31: Client Groups
            const [editCode, setEditCode] = useState('');
            const [unlocked, setUnlocked] = useState(false);
            const [showCodeInput, setShowCodeInput] = useState(false);
            const [darkMode, setDarkMode] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterClient, setFilterClient] = useState('all');
            const [filterDateRange, setFilterDateRange] = useState({ start: '', end: '' });
            const [showReports, setShowReports] = useState(false);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [expandedEntry, setExpandedEntry] = useState(null);
            const [tooltip, setTooltip] = useState({ show: false, text: '', x: 0, y: 0 });
            const [reminders, setReminders] = useState([]);
            const [showNotesModal, setShowNotesModal] = useState(false);
            const [projectNotes, setProjectNotes] = useState({});
            const [currentNoteKey, setCurrentNoteKey] = useState('');
            const [currentNoteText, setCurrentNoteText] = useState('');
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [selectedClient, setSelectedClient] = useState(null);
            const [toast, setToast] = useState(null); // Issue 102: Confirmation messages
            const [loading, setLoading] = useState(false); // Issue 57: Loading States
            const [selectedEntries, setSelectedEntries] = useState([]); // Issue 15: Bulk Edit
            const [showTemplateModal, setShowTemplateModal] = useState(false); // Issue 17: Entry Templates
            const [currentPage2, setCurrentPage2] = useState(1); // Issue 51: Pagination
            const [sortConfig, setSortConfig] = useState({ key: 'date', direction: 'desc' }); // Issue 50: Sorting
            const [collapsedSections, setCollapsedSections] = useState({}); // Issue 55: Collapsible Sections
            const [lastActivityTime, setLastActivityTime] = useState(Date.now()); // Issue 13: Idle Detection
            const [showIdleWarning, setShowIdleWarning] = useState(false); // Issue 13: Idle Detection
            
            // Timer state with pause functionality (Issues 7, 8, 12)
            const [timer, setTimer] = useState({
                isRunning: false,
                isPaused: false, // Issue 7: Pause Timer
                startTime: null,
                pausedTime: null, // Issue 7: Track when paused
                elapsedSeconds: 0,
                currentClient: '',
                currentProject: '',
                currentNotes: '',
                breaks: [] // Issue 1, 12: Break tracking in timer
            });

            // Issue 6: Improved debounce for NotesEditor with race condition handling
            const NotesEditor = ({ entryId, value, disabled }) => {
                const [draft, setDraft] = useState(value || '');
                const debounceTimeout = useRef(null);
                const pendingUpdate = useRef(null);
                const latestValue = useRef(value);
                const textareaRef = useRef(null);

                useEffect(() => {
                    latestValue.current = value;
                    setDraft(value || '');
                }, [value, entryId]);

                // Issue 5: Proper cleanup of timeout on unmount
                useEffect(() => {
                    return () => {
                        if (debounceTimeout.current) {
                            clearTimeout(debounceTimeout.current);
                            debounceTimeout.current = null;
                        }
                    };
                }, []);

                const handleChange = (e) => {
                    const nextValue = e.target.value;
                    setDraft(nextValue);
                    
                    // Issue 6: Cancel any pending update
                    if (debounceTimeout.current) {
                        clearTimeout(debounceTimeout.current);
                    }
                    
                    // Store the pending value to handle race conditions
                    pendingUpdate.current = nextValue;
                    
                    debounceTimeout.current = setTimeout(() => {
                        // Only update if this is still the latest pending value
                        if (pendingUpdate.current === nextValue) {
                            updateEntry(entryId, 'notes', nextValue);
                            pendingUpdate.current = null;
                        }
                    }, 500);
                };

                return (
                    <textarea
                        ref={textareaRef}
                        value={draft}
                        disabled={disabled}
                        onChange={handleChange}
                        rows="1"
                        className={`bg-transparent w-48 ${disabled ? 'opacity-60' : 'border border-dashed rounded p-1 focus:ring-2 focus:ring-blue-500'}`}
                    />
                );
            };
            
            const [customization, setCustomization] = useState({ ...DEFAULT_CUSTOMIZATION });
            const [showManualEntryModal, setShowManualEntryModal] = useState(false);
            const [manualEntryData, setManualEntryData] = useState(null);
            const tooltipTimeout = useRef(null);
            const timerInterval = useRef(null);
            const idleCheckInterval = useRef(null); // Issue 13: Idle Detection
            const autoStopTimeout = useRef(null); // Issue 11: Auto-stop Timer
            const breakReminderInterval = useRef(null); // Issue 63: Break Reminders
            const sessionTimeoutRef = useRef(null); // Issue 92: Session Timeout
            const defaultViewInitialized = useRef(false);
            const ADMIN_CODE = '1234';

            const ensureArray = (value) => (Array.isArray(value) ? value : []);

            const normalizeBreak = (brk = {}, idx = 0) => ({
                id: brk.id ?? Date.now() + idx,
                duration: typeof brk.duration === 'number' ? brk.duration : parseInt(brk.duration, 10) || 0,
                description: brk.description || ''
            });

            // Issue 2: Helper function for consistent local timezone date handling
            const getLocalDateString = (date = new Date()) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            // Issue 2: Get local time string (HH:MM format)
            const getLocalTimeString = (date = new Date()) => {
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            };

            const normalizeEntry = (entry = {}, idx = 0) => {
                const safeBreaks = ensureArray(entry.breaks).map((brk, breakIdx) => normalizeBreak(brk, breakIdx));
                const parsedHours = parseFloat(entry.totalHours);
                const normalizedHours = isNaN(parsedHours)
                    ? (entry.totalHours !== undefined ? entry.totalHours : '0')
                    : parsedHours.toFixed(2);

                return {
                    id: entry.id ?? Date.now() + idx,
                    date: entry.date || getLocalDateString(),
                    client: entry.client || '',
                    project: entry.project || '',
                    timeStarted: entry.timeStarted || '',
                    breaks: safeBreaks,
                    timeDone: entry.timeDone || '',
                    totalHours: normalizedHours,
                    notes: entry.notes || '',
                    reminderDuration: entry.reminderDuration ?? customization.defaultReminderDuration,
                    // New fields for enhanced functionality
                    tags: ensureArray(entry.tags), // Issue 21: Entry Tags
                    attachments: ensureArray(entry.attachments), // Issue 23: Attach Files
                    recurringId: entry.recurringId || null // Issue 19: Recurring Entries
                };
            };

            const normalizeEntries = (entryList = []) => ensureArray(entryList).map((entry, idx) => normalizeEntry(entry, idx));

            const normalizeProject = (project = {}, idx = 0) => ({
                id: project.id ?? Date.now() + idx,
                name: project.name || `Project ${idx + 1}`,
                budget: parseFloat(project.budget) || 0,
                notes: project.notes || '',
                status: project.status || 'active' // Issue 24: Project Status
            });

            const normalizeClient = (client = {}, idx = 0) => ({
                id: client.id ?? Date.now() + idx,
                name: client.name || `Client ${idx + 1}`,
                projects: ensureArray(client.projects).map((project, projectIdx) => normalizeProject(project, projectIdx)),
                color: client.color || '#6B7280',
                hourlyRate: parseFloat(client.hourlyRate) || 0,
                notes: client.notes || '',
                contact: {
                    email: client.contact?.email || '',
                    phone: client.contact?.phone || '',
                    address: client.contact?.address || ''
                },
                group: client.group || '', // Issue 31: Client Groups
                archived: client.archived || false // Issue 32: Client Archive
            });

            const normalizeClients = (clientList = []) => ensureArray(clientList).map((client, idx) => normalizeClient(client, idx));

            const createManualEntry = (date = getLocalDateString()) => ({
                date,
                client: '',
                project: '',
                timeStarted: '',
                timeDone: '',
                breaks: [],
                notes: '',
                reminderDuration: customization.defaultReminderDuration,
                tags: [],
                attachments: []
            });

            const formatHoursDisplay = (value) => {
                if (value === 'Invalid') return 'Invalid';
                const numeric = typeof value === 'number' ? value : parseFloat(value);
                if (isNaN(numeric)) return '0m';
                const totalMinutes = Math.round(numeric * 60);
                let hours = Math.floor(totalMinutes / 60);
                let minutes = totalMinutes % 60;
                if (minutes === 60) {
                    hours += 1;
                    minutes = 0;
                }
                if (hours === 0 && minutes === 0) return '0m';
                if (hours === 0) return `${minutes}m`;
                if (minutes === 0) return `${hours}h`;
                return `${hours}h${minutes.toString().padStart(2, '0')}`;
            };

            const formatDisplayTime = (timeString) => {
                if (!timeString) return '--';
                if (customization.timeFormat === '24h') return timeString;
                const [hours, minutes] = timeString.split(':');
                const hourNumber = parseInt(hours, 10);
                if (isNaN(hourNumber)) return timeString;
                const suffix = hourNumber >= 12 ? 'PM' : 'AM';
                const normalizedHour = ((hourNumber + 11) % 12) + 1;
                const safeMinutes = (minutes || '00').padStart(2, '0');
                return `${normalizedHour}:${safeMinutes} ${suffix}`;
            };

            // Issue 86: Format date based on user preference
            const formatDisplayDate = (dateString) => {
                if (!dateString) return '--';
                const [year, month, day] = dateString.split('-');
                switch (customization.dateFormat) {
                    case 'MM/DD/YYYY':
                        return `${month}/${day}/${year}`;
                    case 'DD/MM/YYYY':
                        return `${day}/${month}/${year}`;
                    default:
                        return dateString;
                }
            };

            // Show toast notification
            const showToast = (message, type = 'success') => {
                setToast({ message, type });
            };

            // Timer effect with persistence (Issues 7, 8)
            useEffect(() => {
                if (timer.isRunning && !timer.isPaused) {
                    timerInterval.current = setInterval(() => {
                        setTimer(prev => ({
                            ...prev,
                            elapsedSeconds: Math.floor((Date.now() - prev.startTime) / 1000)
                        }));
                    }, 1000);
                } else {
                    if (timerInterval.current) {
                        clearInterval(timerInterval.current);
                        timerInterval.current = null;
                    }
                }

                // Issue 5: Proper cleanup
                return () => {
                    if (timerInterval.current) {
                        clearInterval(timerInterval.current);
                        timerInterval.current = null;
                    }
                };
            }, [timer.isRunning, timer.isPaused]);

            // Issue 8: Timer persistence - save to localStorage
            useEffect(() => {
                if (timer.isRunning) {
                    localStorage.setItem('timesheet-timer', JSON.stringify(timer));
                } else {
                    localStorage.removeItem('timesheet-timer');
                }
            }, [timer]);

            // Issue 11: Auto-stop timer after X hours
            useEffect(() => {
                if (timer.isRunning && !timer.isPaused && customization.autoStopTimer) {
                    const maxMs = customization.autoStopHours * 3600 * 1000;
                    const elapsed = Date.now() - timer.startTime;
                    const remaining = maxMs - elapsed;
                    
                    if (remaining > 0) {
                        autoStopTimeout.current = setTimeout(() => {
                            stopTimer();
                            showToast(`Timer auto-stopped after ${customization.autoStopHours} hours`, 'info');
                        }, remaining);
                    }
                }
                
                return () => {
                    if (autoStopTimeout.current) {
                        clearTimeout(autoStopTimeout.current);
                        autoStopTimeout.current = null;
                    }
                };
            }, [timer.isRunning, timer.isPaused, timer.startTime, customization.autoStopTimer, customization.autoStopHours]);

            // Issue 13: Idle detection
            useEffect(() => {
                if (!customization.idleDetection || !timer.isRunning || timer.isPaused) {
                    if (idleCheckInterval.current) {
                        clearInterval(idleCheckInterval.current);
                        idleCheckInterval.current = null;
                    }
                    return;
                }

                const handleActivity = () => {
                    setLastActivityTime(Date.now());
                    setShowIdleWarning(false);
                };

                window.addEventListener('mousemove', handleActivity);
                window.addEventListener('keydown', handleActivity);
                window.addEventListener('click', handleActivity);

                idleCheckInterval.current = setInterval(() => {
                    const idleTime = (Date.now() - lastActivityTime) / 1000 / 60;
                    if (idleTime >= customization.idleThresholdMinutes && !showIdleWarning) {
                        setShowIdleWarning(true);
                    }
                }, 30000);

                return () => {
                    window.removeEventListener('mousemove', handleActivity);
                    window.removeEventListener('keydown', handleActivity);
                    window.removeEventListener('click', handleActivity);
                    if (idleCheckInterval.current) {
                        clearInterval(idleCheckInterval.current);
                        idleCheckInterval.current = null;
                    }
                };
            }, [customization.idleDetection, customization.idleThresholdMinutes, timer.isRunning, timer.isPaused, lastActivityTime, showIdleWarning]);

            // Issue 63: Break reminders
            useEffect(() => {
                if (!customization.breakReminderEnabled || !timer.isRunning || timer.isPaused) {
                    if (breakReminderInterval.current) {
                        clearInterval(breakReminderInterval.current);
                        breakReminderInterval.current = null;
                    }
                    return;
                }

                breakReminderInterval.current = setInterval(() => {
                    if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                        new Notification('Break Reminder', { body: 'Time to take a short break!' });
                    } else {
                        showToast('Time to take a short break!', 'info');
                    }
                }, customization.breakReminderMinutes * 60 * 1000);

                return () => {
                    if (breakReminderInterval.current) {
                        clearInterval(breakReminderInterval.current);
                        breakReminderInterval.current = null;
                    }
                };
            }, [customization.breakReminderEnabled, customization.breakReminderMinutes, timer.isRunning, timer.isPaused]);

            useEffect(() => {
                loadData();
                checkReminders();
                const interval = setInterval(checkReminders, 60000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            }, [darkMode]);

            // Issue 4: Apply scroll lock consistently to all modals
            useEffect(() => {
                if (showManualEntryModal || showNotesModal || showTemplateModal) {
                    const previousOverflow = document.body.style.overflow;
                    document.body.style.overflow = 'hidden';
                    return () => {
                        document.body.style.overflow = previousOverflow;
                    };
                }
            }, [showManualEntryModal, showNotesModal, showTemplateModal]);

            useEffect(() => {
                if (!defaultViewInitialized.current && customization?.defaultView) {
                    setCurrentPage(customization.defaultView);
                    defaultViewInitialized.current = true;
                }
            }, [customization.defaultView]);

            useEffect(() => {
                if (!selectedClient) return;
                const refreshedClient = clients.find(client => client.id === selectedClient.id);
                if (!refreshedClient) {
                    setSelectedClient(null);
                    if (currentPage === 'client-detail') {
                        setCurrentPage('clients');
                    }
                } else if (refreshedClient !== selectedClient) {
                    setSelectedClient(refreshedClient);
                }
            }, [clients, selectedClient, currentPage]);

            // Issue 5: Cleanup tooltip timeout
            useEffect(() => {
                return () => {
                    if (tooltipTimeout.current) {
                        clearTimeout(tooltipTimeout.current);
                        tooltipTimeout.current = null;
                    }
                };
            }, []);

            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyPress = (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'n') {
                            e.preventDefault();
                            addEntry();
                        } else if (e.key === 'd') {
                            e.preventDefault();
                            addEntryForDate();
                        } else if (e.key === 'z' && !e.shiftKey) {
                            e.preventDefault();
                            undo();
                        } else if (e.key === 'z' && e.shiftKey) {
                            e.preventDefault();
                            redo();
                        } else if (e.key === 's') {
                            e.preventDefault();
                            exportToExcel();
                        } else if (e.key === 'r') {
                            e.preventDefault();
                            setShowReports(!showReports);
                        } else if (e.key === '1') {
                            e.preventDefault();
                            setCurrentPage('dashboard');
                        } else if (e.key === '2') {
                            e.preventDefault();
                            setCurrentPage('clients');
                        } else if (e.key === 't') {
                            e.preventDefault();
                            if (timer.isRunning) {
                                if (timer.isPaused) {
                                    resumeTimer();
                                } else {
                                    pauseTimer();
                                }
                            } else {
                                startTimer();
                            }
                        } else if (e.key === 'p' && timer.isRunning) {
                            e.preventDefault();
                            if (timer.isPaused) {
                                resumeTimer();
                            } else {
                                pauseTimer();
                            }
                        }
                    }
                    
                    // Issue 47: Escape key to close modals
                    if (e.key === 'Escape') {
                        if (showManualEntryModal) closeManualEntry();
                        if (showNotesModal) closeNotesModal();
                        if (showTemplateModal) setShowTemplateModal(false);
                    }
                };
                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [entries, history, historyIndex, showReports, unlocked, currentPage, timer.isRunning, timer.isPaused, showManualEntryModal, showNotesModal, showTemplateModal]);

            // Timer functions with pause support (Issues 7, 12)
            const startTimer = () => {
                const now = Date.now();
                setTimer({
                    isRunning: true,
                    isPaused: false,
                    startTime: now,
                    pausedTime: null,
                    elapsedSeconds: 0,
                    currentClient: '',
                    currentProject: '',
                    currentNotes: '',
                    breaks: []
                });
                setLastActivityTime(now);
                showToast('Timer started', 'success');
            };

            // Issue 7: Pause timer
            const pauseTimer = () => {
                if (!timer.isRunning || timer.isPaused) return;
                
                setTimer(prev => ({
                    ...prev,
                    isPaused: true,
                    pausedTime: Date.now(),
                    elapsedSeconds: Math.floor((Date.now() - prev.startTime) / 1000)
                }));
                showToast('Timer paused', 'info');
            };

            // Issue 7: Resume timer
            const resumeTimer = () => {
                if (!timer.isRunning || !timer.isPaused) return;
                
                const pauseDuration = Date.now() - timer.pausedTime;
                setTimer(prev => ({
                    ...prev,
                    isPaused: false,
                    pausedTime: null,
                    startTime: prev.startTime + pauseDuration
                }));
                setLastActivityTime(Date.now());
                showToast('Timer resumed', 'success');
            };

            // Issue 12: Add break while timer is running
            const addTimerBreak = () => {
                if (!timer.isRunning) return;
                
                const newBreak = {
                    id: Date.now(),
                    duration: 0,
                    description: '',
                    startTime: Date.now()
                };
                
                setTimer(prev => ({
                    ...prev,
                    breaks: [...prev.breaks, newBreak]
                }));
            };

            // Issue 12: Update timer break
            const updateTimerBreak = (breakId, field, value) => {
                setTimer(prev => ({
                    ...prev,
                    breaks: prev.breaks.map(brk =>
                        brk.id === breakId ? { ...brk, [field]: value } : brk
                    )
                }));
            };

            // Issue 12: Remove timer break
            const removeTimerBreak = (breakId) => {
                setTimer(prev => ({
                    ...prev,
                    breaks: prev.breaks.filter(brk => brk.id !== breakId)
                }));
            };

            const stopTimer = () => {
                if (!timer.isRunning) return;

                const now = new Date();
                // Issue 2: Use local timezone
                const startTime = new Date(timer.startTime);
                
                const timeStarted = getLocalTimeString(startTime);
                const timeDone = getLocalTimeString(now);
                const date = getLocalDateString(now);

                // Calculate total hours accounting for breaks (Issue 1)
                const totalBreakMinutes = timer.breaks.reduce((sum, brk) => sum + (parseInt(brk.duration) || 0), 0);
                const grossSeconds = timer.elapsedSeconds;
                const netSeconds = grossSeconds - (totalBreakMinutes * 60);
                const totalHours = Math.max(0, netSeconds / 3600).toFixed(2);

                const newEntry = {
                    id: Date.now(),
                    date,
                    client: timer.currentClient,
                    project: timer.currentProject,
                    timeStarted,
                    breaks: timer.breaks.map(brk => ({
                        id: brk.id,
                        duration: brk.duration,
                        description: brk.description
                    })),
                    timeDone,
                    totalHours,
                    notes: timer.currentNotes,
                    reminderDuration: customization.defaultReminderDuration,
                    tags: [],
                    attachments: []
                };

                saveEntries([...entries, newEntry]);
                setTimer({
                    isRunning: false,
                    isPaused: false,
                    startTime: null,
                    pausedTime: null,
                    elapsedSeconds: 0,
                    currentClient: '',
                    currentProject: '',
                    currentNotes: '',
                    breaks: []
                });
                showToast('Entry saved successfully', 'success');
            };

            const updateTimerField = useCallback((field, value) => {
                setTimer(prev => ({ ...prev, [field]: value }));
            }, []);

            const formatTime = (seconds) => {
                const hrs = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            // Performance-optimized calculations with useMemo
            const todayStats = useMemo(() => {
                const today = getLocalDateString();
                const todayEntries = entries.filter(entry => entry.date === today);
                const todayHours = todayEntries.reduce((sum, entry) => sum + parseFloat(entry.totalHours || 0), 0);
                const activeClients = new Set(todayEntries.map(entry => entry.client).filter(Boolean)).size;
                
                return {
                    hours: todayHours,
                    entries: todayEntries.length,
                    activeClients
                };
            }, [entries]);

            const weekStats = useMemo(() => {
                const today = new Date();
                const startOfWeek = new Date(today);
                // Issue 87: First day of week setting
                const firstDay = customization.firstDayOfWeek === 'sunday' ? 0 : 1;
                const currentDay = today.getDay();
                const diff = currentDay >= firstDay ? currentDay - firstDay : 7 - (firstDay - currentDay);
                startOfWeek.setDate(today.getDate() - diff);
                startOfWeek.setHours(0, 0, 0, 0);

                const weekEntries = entries.filter(entry => {
                    const entryDate = new Date(entry.date + 'T00:00:00');
                    return entryDate >= startOfWeek && entryDate <= today;
                });

                const weekHours = weekEntries.reduce((sum, entry) => sum + parseFloat(entry.totalHours || 0), 0);
                const daysWorked = new Set(weekEntries.map(entry => entry.date)).size;
                const dailyAverage = daysWorked > 0 ? (weekHours / daysWorked) : 0;

                return {
                    hours: weekHours,
                    dailyAverage,
                    daysWorked
                };
            }, [entries, customization.firstDayOfWeek]);

            const weekData = useMemo(() => {
                const days = [];
                const today = new Date();
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    const dateString = getLocalDateString(date);
                    const dayEntries = entries.filter(entry => entry.date === dateString);
                    const hours = dayEntries.reduce((sum, entry) => sum + parseFloat(entry.totalHours || 0), 0);
                    
                    days.push({
                        date: dateString,
                        day: date.toLocaleDateString('en-US', { weekday: 'short' }),
                        hours,
                        isToday: i === 0
                    });
                }
                
                return days;
            }, [entries]);

            const topClients = useMemo(() => {
                const clientHours = {};
                entries.forEach(entry => {
                    const clientName = entry.client || 'No Client';
                    if (!clientHours[clientName]) clientHours[clientName] = 0;
                    const hours = parseFloat(entry.totalHours);
                    if (!isNaN(hours)) clientHours[clientName] += hours;
                });

                return Object.entries(clientHours)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([client, hours], index) => ({
                        client,
                        hours,
                        medal: index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : '',
                        color: clients.find(c => c.name === client)?.color || '#6B7280'
                    }));
            }, [entries, clients]);

            const recentActivity = useMemo(() => {
                return [...entries]
                    .sort((a, b) => new Date(b.date + 'T' + (b.timeStarted || '00:00')) - new Date(a.date + 'T' + (a.timeStarted || '00:00')))
                    .slice(0, 5);
            }, [entries]);

            const maxWeekHours = useMemo(() => {
                return Math.max(...weekData.map(day => day.hours), 1);
            }, [weekData]);

            // Data migration function for backward compatibility
            const migrateData = (data, version) => {
                if (!version || version < 2) {
                    // Migrate v1 data to v2
                    if (data.entries) {
                        data.entries = data.entries.map(entry => ({
                            ...entry,
                            tags: entry.tags || [],
                            attachments: entry.attachments || [],
                            recurringId: entry.recurringId || null
                        }));
                    }
                    if (data.clients) {
                        data.clients = data.clients.map(client => ({
                            ...client,
                            group: client.group || '',
                            archived: client.archived || false,
                            projects: (client.projects || []).map(project => ({
                                ...project,
                                status: project.status || 'active'
                            }))
                        }));
                    }
                }
                return data;
            };

            // Enhanced loadData with migration and new data types
            const loadData = () => {
                try {
                    const savedVersion = localStorage.getItem('timesheet-version');
                    const savedEntries = localStorage.getItem('timesheet-entries');
                    const savedClients = localStorage.getItem('timesheet-clients');
                    const savedArchivedClients = localStorage.getItem('timesheet-archived-clients');
                    const savedDarkMode = localStorage.getItem('timesheet-darkmode');
                    const savedReminders = localStorage.getItem('timesheet-reminders');
                    const savedNotes = localStorage.getItem('timesheet-project-notes');
                    const savedCustomization = localStorage.getItem('timesheet-customization');
                    const savedTags = localStorage.getItem('timesheet-tags');
                    const savedTemplates = localStorage.getItem('timesheet-templates');
                    const savedFilters = localStorage.getItem('timesheet-saved-filters');
                    const savedSearchHistory = localStorage.getItem('timesheet-search-history');
                    const savedClientGroups = localStorage.getItem('timesheet-client-groups');
                    const savedTimer = localStorage.getItem('timesheet-timer');
                    
                    const version = savedVersion ? parseInt(savedVersion) : 1;
                    
                    if (savedEntries) {
                        let parsedEntries = JSON.parse(savedEntries);
                        if (version < DATA_VERSION) {
                            parsedEntries = migrateData({ entries: parsedEntries }, version).entries;
                        }
                        setEntries(normalizeEntries(parsedEntries));
                    }
                    if (savedClients) {
                        let parsedClients = JSON.parse(savedClients);
                        if (version < DATA_VERSION) {
                            parsedClients = migrateData({ clients: parsedClients }, version).clients;
                        }
                        setClients(normalizeClients(parsedClients));
                    }
                    if (savedArchivedClients) setArchivedClients(normalizeClients(JSON.parse(savedArchivedClients)));
                    if (savedDarkMode) setDarkMode(JSON.parse(savedDarkMode));
                    if (savedReminders) setReminders(JSON.parse(savedReminders));
                    if (savedNotes) setProjectNotes(JSON.parse(savedNotes));
                    if (savedCustomization) {
                        const parsedCustomization = JSON.parse(savedCustomization);
                        setCustomization({ ...DEFAULT_CUSTOMIZATION, ...parsedCustomization });
                    }
                    if (savedTags) setTags(JSON.parse(savedTags));
                    if (savedTemplates) setTemplates(JSON.parse(savedTemplates));
                    if (savedFilters) setSavedFilters(JSON.parse(savedFilters));
                    if (savedSearchHistory) setSearchHistory(JSON.parse(savedSearchHistory));
                    if (savedClientGroups) setClientGroups(JSON.parse(savedClientGroups));
                    
                    // Issue 8: Restore timer state
                    if (savedTimer) {
                        const timerData = JSON.parse(savedTimer);
                        if (timerData.isRunning) {
                            // Recalculate elapsed time
                            const elapsed = Math.floor((Date.now() - timerData.startTime) / 1000);
                            setTimer({
                                ...timerData,
                                elapsedSeconds: elapsed
                            });
                        }
                    }
                    
                    // Update version
                    localStorage.setItem('timesheet-version', DATA_VERSION.toString());
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            };

            const saveToHistory = (newEntries) => {
                const newHistory = history.slice(0, historyIndex + 1);
                newHistory.push(JSON.stringify(newEntries));
                if (newHistory.length > 50) newHistory.shift();
                setHistory(newHistory);
                setHistoryIndex(newHistory.length - 1);
            };

            const saveEntries = (newEntries) => {
                try {
                    setLoading(true);
                    const normalizedEntries = normalizeEntries(newEntries);
                    localStorage.setItem('timesheet-entries', JSON.stringify(normalizedEntries));
                    setEntries(normalizedEntries);
                    saveToHistory(normalizedEntries);
                } catch (error) {
                    console.error('Failed to save entries:', error);
                    showToast('Failed to save. Please try again.', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const saveClients = (newClients) => {
                try {
                    const normalizedClients = normalizeClients(newClients);
                    localStorage.setItem('timesheet-clients', JSON.stringify(normalizedClients));
                    setClients(normalizedClients);
                } catch (error) {
                    console.error('Failed to save clients:', error);
                    showToast('Failed to save clients.', 'error');
                }
            };

            // Issue 32: Save archived clients
            const saveArchivedClients = (newArchivedClients) => {
                try {
                    const normalizedClients = normalizeClients(newArchivedClients);
                    localStorage.setItem('timesheet-archived-clients', JSON.stringify(normalizedClients));
                    setArchivedClients(normalizedClients);
                } catch (error) {
                    console.error('Failed to save archived clients:', error);
                }
            };

            // Issue 21: Save tags
            const saveTags = (newTags) => {
                localStorage.setItem('timesheet-tags', JSON.stringify(newTags));
                setTags(newTags);
            };

            // Issue 17: Save templates
            const saveTemplates = (newTemplates) => {
                localStorage.setItem('timesheet-templates', JSON.stringify(newTemplates));
                setTemplates(newTemplates);
            };

            // Issue 43: Save filters
            const saveSavedFilters = (newFilters) => {
                localStorage.setItem('timesheet-saved-filters', JSON.stringify(newFilters));
                setSavedFilters(newFilters);
            };

            // Issue 45: Save search history
            const addToSearchHistory = (term) => {
                if (!term.trim()) return;
                const newHistory = [term, ...searchHistory.filter(h => h !== term)].slice(0, 10);
                localStorage.setItem('timesheet-search-history', JSON.stringify(newHistory));
                setSearchHistory(newHistory);
            };

            // Issue 31: Save client groups
            const saveClientGroups = (newGroups) => {
                localStorage.setItem('timesheet-client-groups', JSON.stringify(newGroups));
                setClientGroups(newGroups);
            };

            const saveDarkMode = (mode) => {
                localStorage.setItem('timesheet-darkmode', JSON.stringify(mode));
                setDarkMode(mode);
            };

            const saveReminders = (newReminders) => {
                localStorage.setItem('timesheet-reminders', JSON.stringify(newReminders));
                setReminders(newReminders);
            };

            const saveProjectNotes = (notes) => {
                localStorage.setItem('timesheet-project-notes', JSON.stringify(notes));
                setProjectNotes(notes);
            };

            const saveCustomization = (newCustomization) => {
                localStorage.setItem('timesheet-customization', JSON.stringify(newCustomization));
                setCustomization(newCustomization);
            };

            const updateCustomization = (field, value) => {
                saveCustomization({ ...customization, [field]: value });
            };

            const openNotesModal = (clientName, projectName) => {
                const key = `${clientName}:::${projectName}`;
                setCurrentNoteKey(key);
                setCurrentNoteText(projectNotes[key] || '');
                setShowNotesModal(true);
            };

            const saveNote = () => {
                const updatedNotes = { ...projectNotes, [currentNoteKey]: currentNoteText };
                saveProjectNotes(updatedNotes);
                setShowNotesModal(false);
                setCurrentNoteText('');
                setCurrentNoteKey('');
                showToast('Note saved', 'success');
            };

            const closeNotesModal = () => {
                setShowNotesModal(false);
                setCurrentNoteText('');
                setCurrentNoteKey('');
            };

            const undo = () => {
                if (historyIndex > 0) {
                    const newIndex = historyIndex - 1;
                    const previousState = JSON.parse(history[newIndex]);
                    setEntries(previousState);
                    setHistoryIndex(newIndex);
                    localStorage.setItem('timesheet-entries', JSON.stringify(previousState));
                    showToast('Undo successful', 'success');
                }
            };

            const redo = () => {
                if (historyIndex < history.length - 1) {
                    const newIndex = historyIndex + 1;
                    const nextState = JSON.parse(history[newIndex]);
                    setEntries(nextState);
                    setHistoryIndex(newIndex);
                    localStorage.setItem('timesheet-entries', JSON.stringify(nextState));
                    showToast('Redo successful', 'success');
                }
            };

            // Issue 2: Use local timezone consistently
            function getTodayDate() {
                return getLocalDateString();
            }

            function isToday(date) {
                return date === getLocalDateString();
            }

            const openManualEntry = (date = getLocalDateString()) => {
                setManualEntryData(createManualEntry(date));
                setShowManualEntryModal(true);
            };

            const closeManualEntry = () => {
                setShowManualEntryModal(false);
                setManualEntryData(null);
            };

            const updateManualEntryField = (field, value) => {
                setManualEntryData(prev => {
                    if (!prev) return prev;
                    const updated = { ...prev, [field]: value };
                    if (field === 'client') {
                        updated.project = '';
                    }
                    return updated;
                });
            };

            const addManualEntryBreak = () => {
                setManualEntryData(prev => {
                    if (!prev) return prev;
                    const newBreak = { id: Date.now(), duration: 0, description: '' };
                    return { ...prev, breaks: [...ensureArray(prev.breaks), newBreak] };
                });
            };

            const updateManualEntryBreak = (breakId, field, value) => {
                setManualEntryData(prev => {
                    if (!prev) return prev;
                    const safeBreaks = ensureArray(prev.breaks).map(brk =>
                        brk.id === breakId ? { ...brk, [field]: value } : brk
                    );
                    return { ...prev, breaks: safeBreaks };
                });
            };

            const removeManualEntryBreak = (breakId) => {
                setManualEntryData(prev => {
                    if (!prev) return prev;
                    const safeBreaks = ensureArray(prev.breaks).filter(brk => brk.id !== breakId);
                    return { ...prev, breaks: safeBreaks };
                });
            };

            const handleManualEntrySubmit = (e) => {
                e.preventDefault();
                if (!manualEntryData) return;
                if (!manualEntryData.date) {
                    showToast('Please provide a date.', 'error');
                    return;
                }
                if (!manualEntryData.timeStarted || !manualEntryData.timeDone) {
                    showToast('Please provide both start and end times.', 'error');
                    return;
                }

                const computedHours = calculateTotalHours(
                    manualEntryData.timeStarted,
                    manualEntryData.breaks,
                    manualEntryData.timeDone
                );

                if (computedHours === 'Invalid') {
                    showToast('Time done must be after time started.', 'error');
                    return;
                }

                const preparedEntry = normalizeEntry({
                    ...manualEntryData,
                    id: Date.now(),
                    totalHours: computedHours
                });

                saveEntries([...entries, preparedEntry]);
                closeManualEntry();
                showToast('Entry created successfully', 'success');
            };

            const addEntry = () => {
                openManualEntry();
            };

            const addEntryForDate = () => {
                const dateInput = prompt('Enter date (YYYY-MM-DD) or leave blank for today:');
                const selectedDate = dateInput && dateInput.trim() ? dateInput.trim() : getLocalDateString();
                
                if (!/^\d{4}-\d{2}-\d{2}$/.test(selectedDate)) {
                    showToast('Invalid date format. Please use YYYY-MM-DD', 'error');
                    return;
                }
                
                if (selectedDate < getLocalDateString() && !unlocked) {
                    showToast('Cannot create entries for past dates. Please unlock first.', 'error');
                    return;
                }
                
                openManualEntry(selectedDate);
            };

            // Issue 16: Duplicate entry
            const duplicateEntry = (entryId) => {
                const entry = entries.find(e => e.id === entryId);
                if (!entry) return;
                
                const duplicated = {
                    ...entry,
                    id: Date.now(),
                    date: getLocalDateString(),
                    timeStarted: '',
                    timeDone: '',
                    totalHours: '0'
                };
                
                saveEntries([...entries, duplicated]);
                showToast('Entry duplicated', 'success');
            };

            // Issue 17: Save as template
            const saveAsTemplate = (entry) => {
                const templateName = prompt('Enter template name:');
                if (!templateName?.trim()) return;
                
                const template = {
                    id: Date.now(),
                    name: templateName.trim(),
                    client: entry.client,
                    project: entry.project,
                    notes: entry.notes,
                    tags: entry.tags || [],
                    reminderDuration: entry.reminderDuration
                };
                
                saveTemplates([...templates, template]);
                showToast('Template saved', 'success');
            };

            // Issue 17: Apply template
            const applyTemplate = (template) => {
                setManualEntryData({
                    ...createManualEntry(),
                    client: template.client,
                    project: template.project,
                    notes: template.notes,
                    tags: template.tags || [],
                    reminderDuration: template.reminderDuration
                });
                setShowTemplateModal(false);
                setShowManualEntryModal(true);
            };

            // Issue 17: Delete template
            const deleteTemplate = (templateId) => {
                if (customization.confirmDeletions && !confirm('Delete this template?')) return;
                saveTemplates(templates.filter(t => t.id !== templateId));
                showToast('Template deleted', 'success');
            };

            const addClient = () => {
                const clientName = prompt('Enter client name:');
                if (clientName && clientName.trim()) {
                    const newClient = {
                        id: Date.now(),
                        name: clientName.trim(),
                        projects: [],
                        color: `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`,
                        hourlyRate: 0,
                        notes: '',
                        contact: {
                            email: '',
                            phone: '',
                            address: ''
                        },
                        group: '',
                        archived: false
                    };
                    saveClients([...clients, newClient]);
                    showToast('Client added', 'success');
                }
            };

            const updateClientField = (clientId, field, value) => {
                updateClient(clientId, { [field]: value });
            };

            const updateClientContactField = (clientId, field, value) => {
                const target = clients.find(client => client.id === clientId);
                const existingContact = target?.contact || { email: '', phone: '', address: '' };
                updateClient(clientId, { contact: { ...existingContact, [field]: value } });
            };

            const updateClientProjectField = (clientId, projectId, updates) => {
                const target = clients.find(client => client.id === clientId);
                if (!target) return;
                const updatedProjects = target.projects.map(project =>
                    project.id === projectId ? { ...project, ...updates } : project
                );
                updateClient(clientId, { projects: updatedProjects });
            };

            const updateClient = (clientId, updates) => {
                const updatedClients = clients.map(client => 
                    client.id === clientId ? { ...client, ...updates } : client
                );
                saveClients(updatedClients);
            };

            // Issue 32: Archive client instead of delete
            const archiveClient = (clientId) => {
                const client = clients.find(c => c.id === clientId);
                if (!client) return;
                
                if (customization.confirmDeletions && !confirm('Archive this client? You can restore it later.')) {
                    return;
                }
                
                const archivedClient = { ...client, archived: true, archivedAt: Date.now() };
                saveArchivedClients([...archivedClients, archivedClient]);
                saveClients(clients.filter(c => c.id !== clientId));
                showToast('Client archived', 'success');
            };

            // Issue 32: Restore archived client
            const restoreClient = (clientId) => {
                const client = archivedClients.find(c => c.id === clientId);
                if (!client) return;
                
                const restoredClient = { ...client, archived: false };
                delete restoredClient.archivedAt;
                
                saveClients([...clients, restoredClient]);
                saveArchivedClients(archivedClients.filter(c => c.id !== clientId));
                showToast('Client restored', 'success');
            };

            // Issue 32: Permanently delete archived client
            const deleteClient = (clientId) => {
                if (customization.confirmDeletions && !confirm('Permanently delete this client? Entries will remain but show "No Client".')) {
                    return;
                }
                const clientToDelete = clients.find(c => c.id === clientId) || archivedClients.find(c => c.id === clientId);
                if (!clientToDelete) return;
                
                const updatedEntries = entries.map(entry => 
                    entry.client === clientToDelete.name 
                        ? { ...entry, client: '' } 
                        : entry
                );
                saveEntries(updatedEntries);
                saveClients(clients.filter(client => client.id !== clientId));
                saveArchivedClients(archivedClients.filter(client => client.id !== clientId));
                showToast('Client deleted', 'success');
            };

            const addProjectToClient = (clientId, name) => {
                const projectName = (name && name.trim()) || 'New Project';
                const updatedClients = clients.map(client => {
                    if (client.id === clientId) {
                        return {
                            ...client,
                            projects: [...client.projects, { 
                                id: Date.now(), 
                                name: projectName,
                                budget: 0,
                                notes: '',
                                status: 'active'
                            }]
                        };
                    }
                    return client;
                });
                saveClients(updatedClients);
                showToast('Project added', 'success');
            };

            const removeProjectFromClient = (clientId, projectId) => {
                const updatedClients = clients.map(client => {
                    if (client.id === clientId) {
                        return {
                            ...client,
                            projects: client.projects.filter(project => project.id !== projectId)
                        };
                    }
                    return client;
                });
                saveClients(updatedClients);
            };

            // Issue 24: Update project status
            const updateProjectStatus = (clientId, projectId, status) => {
                updateClientProjectField(clientId, projectId, { status });
                showToast(`Project marked as ${status}`, 'success');
            };

            const openClientDetail = (client) => {
                setSelectedClient(client);
                setCurrentPage('client-detail');
            };

            const calculateTotalHours = (timeStarted, breaks, timeDone) => {
                if (!timeStarted || !timeDone) return 0;

                const start = new Date(`2000-01-01T${timeStarted}`);
                const end = new Date(`2000-01-01T${timeDone}`);
                
                if (end <= start) {
                    return 'Invalid';
                }

                const safeBreaks = ensureArray(breaks);
                const totalBreakMinutes = safeBreaks.reduce((sum, brk) => sum + (parseInt(brk.duration) || 0), 0);

                let diffMs = end - start;
                const totalMinutes = Math.floor(diffMs / 60000) - totalBreakMinutes;
                
                if (totalMinutes < 0) return 0;
                
                return (totalMinutes / 60).toFixed(2);
            };

            const updateEntry = (id, field, value) => {
                const updatedEntries = entries.map(entry => {
                    if (entry.id === id) {
                        const updated = { ...entry, [field]: value };
                        if (field === 'timeStarted' || field === 'breaks' || field === 'timeDone') {
                            updated.totalHours = calculateTotalHours(
                                updated.timeStarted,
                                updated.breaks,
                                updated.timeDone
                            );
                        }
                        return updated;
                    }
                    return entry;
                });
                saveEntries(updatedEntries);
            };

            const addBreak = (entryId) => {
                const updatedEntries = entries.map(entry => {
                    if (entry.id === entryId) {
                        const newBreak = { id: Date.now(), duration: 0, description: '' };
                        const updatedBreaks = [...ensureArray(entry.breaks), newBreak];
                        const updated = { ...entry, breaks: updatedBreaks };
                        updated.totalHours = calculateTotalHours(updated.timeStarted, updated.breaks, updated.timeDone);
                        return updated;
                    }
                    return entry;
                });
                saveEntries(updatedEntries);
            };

            const updateBreak = (entryId, breakId, field, value) => {
                const updatedEntries = entries.map(entry => {
                    if (entry.id === entryId) {
                        const safeBreaks = ensureArray(entry.breaks);
                        const updatedBreaks = safeBreaks.map(brk => 
                            brk.id === breakId ? { ...brk, [field]: value } : brk
                        );
                        const updated = { ...entry, breaks: updatedBreaks };
                        updated.totalHours = calculateTotalHours(updated.timeStarted, updatedBreaks, updated.timeDone);
                        return updated;
                    }
                    return entry;
                });
                saveEntries(updatedEntries);
            };

            const removeBreak = (entryId, breakId) => {
                const updatedEntries = entries.map(entry => {
                    if (entry.id === entryId) {
                        const safeBreaks = ensureArray(entry.breaks);
                        const updatedBreaks = safeBreaks.filter(brk => brk.id !== breakId);
                        const updated = { ...entry, breaks: updatedBreaks };
                        updated.totalHours = calculateTotalHours(updated.timeStarted, updatedBreaks, updated.timeDone);
                        return updated;
                    }
                    return entry;
                });
                saveEntries(updatedEntries);
            };

            const deleteEntry = (id) => {
                if (customization.confirmDeletions && !confirm('Are you sure you want to delete this entry? This action cannot be undone.')) {
                    return;
                }
                saveEntries(entries.filter(entry => entry.id !== id));
                showToast('Entry deleted', 'success');
            };

            // Issue 15: Bulk delete entries
            const bulkDeleteEntries = () => {
                if (selectedEntries.length === 0) return;
                if (customization.confirmDeletions && !confirm(`Delete ${selectedEntries.length} entries?`)) return;
                
                saveEntries(entries.filter(entry => !selectedEntries.includes(entry.id)));
                setSelectedEntries([]);
                showToast(`${selectedEntries.length} entries deleted`, 'success');
            };

            // Issue 15: Toggle entry selection
            const toggleEntrySelection = (entryId) => {
                setSelectedEntries(prev => 
                    prev.includes(entryId) 
                        ? prev.filter(id => id !== entryId)
                        : [...prev, entryId]
                );
            };

            // Issue 15: Select all entries
            const selectAllEntries = () => {
                if (selectedEntries.length === filteredEntries.length) {
                    setSelectedEntries([]);
                } else {
                    setSelectedEntries(filteredEntries.map(e => e.id));
                }
            };

            // Issue 21: Add tag
            const addTag = (name, color = '#6B7280') => {
                if (!name?.trim()) return;
                const newTag = { id: Date.now(), name: name.trim(), color };
                saveTags([...tags, newTag]);
                showToast('Tag added', 'success');
            };

            // Issue 21: Add tag to entry
            const addTagToEntry = (entryId, tagName) => {
                updateEntry(entryId, 'tags', [...(entries.find(e => e.id === entryId)?.tags || []), tagName]);
            };

            // Issue 21: Remove tag from entry
            const removeTagFromEntry = (entryId, tagName) => {
                const entry = entries.find(e => e.id === entryId);
                if (!entry) return;
                updateEntry(entryId, 'tags', entry.tags.filter(t => t !== tagName));
            };

            const handleUnlock = () => {
                if (editCode === ADMIN_CODE) {
                    setUnlocked(true);
                    setShowCodeInput(false);
                    setEditCode('');
                    setTimeout(() => setUnlocked(false), 300000);
                    showToast('Unlocked for 5 minutes', 'success');
                } else {
                    showToast('Incorrect code', 'error');
                    setEditCode('');
                }
            };

            const canEdit = (date) => isToday(date) || unlocked;

            const setReminder = (entryId, duration) => {
                const entry = entries.find(e => e.id === entryId);
                if (entry && entry.timeStarted && !entry.timeDone) {
                    const reminderTime = new Date();
                    const [hours, minutes] = entry.timeStarted.split(':');
                    reminderTime.setHours(parseInt(hours), parseInt(minutes) + parseInt(duration), 0, 0);
                    
                    const newReminder = {
                        id: Date.now(),
                        entryId,
                        time: reminderTime.getTime(),
                        message: `Check on: ${entry.client || 'Task'} - ${entry.project || 'No project'}`
                    };
                    saveReminders([...reminders, newReminder]);
                    showToast('Reminder set', 'success');
                }
            };

            const checkReminders = () => {
                const now = Date.now();
                const dueReminders = reminders.filter(r => r.time <= now && r.time > now - 60000);
                
                dueReminders.forEach(reminder => {
                    if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                        new Notification('Timesheet Reminder', { body: reminder.message });
                    } else {
                        showToast(reminder.message, 'info');
                    }
                });

                if (dueReminders.length > 0) {
                    saveReminders(reminders.filter(r => r.time > now - 60000));
                }
            };

            const requestNotificationPermission = () => {
                if (typeof Notification !== 'undefined' && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            };

            const exportToExcel = () => {
                setLoading(true);
                try {
                    const exportData = filteredEntries.map(entry => ({
                        Date: formatDisplayDate(entry.date),
                        Client: entry.client,
                        Project: entry.project,
                        'Time Started': formatDisplayTime(entry.timeStarted),
                        'Total Break Time (min)': ensureArray(entry.breaks).reduce((sum, b) => sum + parseInt(b.duration || 0), 0),
                        'Time Done': formatDisplayTime(entry.timeDone),
                        'Total Hours': entry.totalHours,
                        Tags: (entry.tags || []).join(', '),
                        Notes: entry.notes
                    }));

                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Timesheet');
                    XLSX.writeFile(wb, `timesheet_${getLocalDateString()}.xlsx`);
                    showToast('Exported to Excel', 'success');
                } catch (error) {
                    showToast('Export failed', 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Issue 40: Export to CSV
            const exportToCSV = () => {
                setLoading(true);
                try {
                    const headers = ['Date', 'Client', 'Project', 'Time Started', 'Time Done', 'Total Hours', 'Tags', 'Notes'];
                    const rows = filteredEntries.map(entry => [
                        formatDisplayDate(entry.date),
                        entry.client,
                        entry.project,
                        formatDisplayTime(entry.timeStarted),
                        formatDisplayTime(entry.timeDone),
                        entry.totalHours,
                        (entry.tags || []).join('; '),
                        entry.notes
                    ]);
                    
                    const csvContent = [headers, ...rows]
                        .map(row => row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(','))
                        .join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `timesheet_${getLocalDateString()}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('Exported to CSV', 'success');
                } catch (error) {
                    showToast('Export failed', 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Issue 34: Export to PDF
            const exportToPDF = () => {
                setLoading(true);
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Title
                    doc.setFontSize(20);
                    doc.text('Timesheet Report', 14, 22);
                    
                    // Date range
                    doc.setFontSize(10);
                    doc.text(`Generated: ${formatDisplayDate(getLocalDateString())}`, 14, 32);
                    
                    // Summary
                    doc.setFontSize(12);
                    doc.text(`Total Entries: ${filteredEntries.length}`, 14, 42);
                    doc.text(`Total Hours: ${formatHoursDisplay(totalAllHours)}`, 14, 50);
                    
                    // Table headers
                    let y = 65;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('Date', 14, y);
                    doc.text('Client', 40, y);
                    doc.text('Project', 80, y);
                    doc.text('Hours', 120, y);
                    
                    // Table rows
                    doc.setFont(undefined, 'normal');
                    y += 8;
                    
                    filteredEntries.slice(0, 30).forEach(entry => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.text(formatDisplayDate(entry.date), 14, y);
                        doc.text((entry.client || 'No Client').substring(0, 20), 40, y);
                        doc.text((entry.project || 'No Project').substring(0, 20), 80, y);
                        doc.text(formatHoursDisplay(entry.totalHours), 120, y);
                        y += 7;
                    });
                    
                    doc.save(`timesheet_${getLocalDateString()}.pdf`);
                    showToast('Exported to PDF', 'success');
                } catch (error) {
                    console.error('PDF export error:', error);
                    showToast('PDF export failed. Make sure jsPDF is loaded.', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const importFromJSON = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (confirm('Import data? This will merge with existing entries.')) {
                                const importedEntries = Array.isArray(data.entries) ? data.entries : [];
                                saveEntries([...entries, ...importedEntries]);
                                if (data.clients) saveClients([...clients, ...data.clients]);
                                if (data.customization) saveCustomization({...customization, ...data.customization});
                                if (data.tags) saveTags([...tags, ...(data.tags || [])]);
                                if (data.templates) saveTemplates([...templates, ...(data.templates || [])]);
                                showToast('Import successful', 'success');
                            }
                        } catch (error) {
                            showToast('Invalid file format', 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };

            const exportToJSON = () => {
                const data = { 
                    version: DATA_VERSION,
                    exportedAt: new Date().toISOString(),
                    entries, 
                    clients, 
                    archivedClients,
                    customization,
                    tags,
                    templates,
                    savedFilters,
                    clientGroups,
                    projectNotes
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `timesheet_backup_${getLocalDateString()}.json`;
                a.click();
                showToast('Backup exported', 'success');
            };

            const clearAllData = () => {
                if (!confirm('This will remove all saved entries, clients, and settings. Continue?')) return;
                [
                    'timesheet-entries', 'timesheet-clients', 'timesheet-archived-clients',
                    'timesheet-darkmode', 'timesheet-reminders', 'timesheet-project-notes', 
                    'timesheet-customization', 'timesheet-tags', 'timesheet-templates',
                    'timesheet-saved-filters', 'timesheet-search-history', 'timesheet-client-groups',
                    'timesheet-timer', 'timesheet-version'
                ].forEach(key => {
                    localStorage.removeItem(key);
                });
                setEntries([]);
                setClients([]);
                setArchivedClients([]);
                setDarkMode(false);
                setReminders([]);
                setProjectNotes({});
                setCustomization({ ...DEFAULT_CUSTOMIZATION });
                setTags([]);
                setTemplates([]);
                setSavedFilters([]);
                setSearchHistory([]);
                setClientGroups([]);
                setHistory([]);
                setHistoryIndex(-1);
                setShowManualEntryModal(false);
                setManualEntryData(null);
                setSelectedClient(null);
                setCurrentPage('dashboard');
                showToast('All data cleared', 'success');
            };

            const showTooltip = (text, e) => {
                if (!customization.enableTooltips) return;
                if (tooltipTimeout.current) {
                    clearTimeout(tooltipTimeout.current);
                }
                tooltipTimeout.current = setTimeout(() => {
                    setTooltip({ show: true, text, x: e.clientX, y: e.clientY });
                }, 1000);
            };

            const hideTooltip = () => {
                if (tooltipTimeout.current) {
                    clearTimeout(tooltipTimeout.current);
                    tooltipTimeout.current = null;
                }
                setTooltip({ show: false, text: '', x: 0, y: 0 });
            };

            useEffect(() => {
                if (!customization.enableTooltips) {
                    hideTooltip();
                }
            }, [customization.enableTooltips]);

            const timerFormValues = useMemo(() => ({
                currentClient: timer.currentClient,
                currentProject: timer.currentProject,
                currentNotes: timer.currentNotes
            }), [timer.currentClient, timer.currentProject, timer.currentNotes]);

            // Issue 50: Sorting
            const handleSort = (key) => {
                setSortConfig(prev => ({
                    key,
                    direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
                }));
            };

            // Filtering with sorting
            const filteredEntries = useMemo(() => {
                let result = entries.filter(entry => {
                    const matchesSearch = (entry.client || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                                         (entry.project || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                                         (entry.notes || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                                         (entry.tags || []).some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()));
                    const matchesClient = filterClient === 'all' || entry.client === filterClient;
                    const matchesDateRange = (!filterDateRange.start || entry.date >= filterDateRange.start) &&
                                            (!filterDateRange.end || entry.date <= filterDateRange.end);
                    return matchesSearch && matchesClient && matchesDateRange;
                });

                // Issue 50: Apply sorting
                result.sort((a, b) => {
                    let aVal = a[sortConfig.key];
                    let bVal = b[sortConfig.key];
                    
                    if (sortConfig.key === 'totalHours') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    }
                    
                    if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });

                return result;
            }, [entries, searchTerm, filterClient, filterDateRange, sortConfig]);

            // Issue 51: Pagination
            const paginatedEntries = useMemo(() => {
                const startIndex = (currentPage2 - 1) * customization.itemsPerPage;
                return filteredEntries.slice(startIndex, startIndex + customization.itemsPerPage);
            }, [filteredEntries, currentPage2, customization.itemsPerPage]);

            const totalPages = Math.ceil(filteredEntries.length / customization.itemsPerPage);

            const handleDateFilterChange = (field, value) => {
                setFilterDateRange(prev => ({ ...prev, [field]: value }));
            };

            // Issue 44: Smart filters
            const applySmartFilter = (filterType) => {
                const today = new Date();
                let start, end;
                
                switch (filterType) {
                    case 'last30':
                        start = new Date(today);
                        start.setDate(start.getDate() - 30);
                        end = today;
                        break;
                    case 'thisMonth':
                        start = new Date(today.getFullYear(), today.getMonth(), 1);
                        end = today;
                        break;
                    case 'lastMonth':
                        start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        end = new Date(today.getFullYear(), today.getMonth(), 0);
                        break;
                    case 'lastQuarter':
                        start = new Date(today);
                        start.setMonth(start.getMonth() - 3);
                        end = today;
                        break;
                    case 'thisYear':
                        start = new Date(today.getFullYear(), 0, 1);
                        end = today;
                        break;
                    default:
                        return;
                }
                
                setFilterDateRange({
                    start: getLocalDateString(start),
                    end: getLocalDateString(end)
                });
            };

            const resetFilters = () => {
                setSearchTerm('');
                setFilterClient('all');
                setFilterDateRange({ start: '', end: '' });
                setCurrentPage2(1);
            };

            // Issue 43: Save current filter
            const saveCurrentFilter = () => {
                const filterName = prompt('Enter filter name:');
                if (!filterName?.trim()) return;
                
                const filter = {
                    id: Date.now(),
                    name: filterName.trim(),
                    searchTerm,
                    filterClient,
                    filterDateRange
                };
                
                saveSavedFilters([...savedFilters, filter]);
                showToast('Filter saved', 'success');
            };

            // Issue 43: Apply saved filter
            const applySavedFilter = (filter) => {
                setSearchTerm(filter.searchTerm || '');
                setFilterClient(filter.filterClient || 'all');
                setFilterDateRange(filter.filterDateRange || { start: '', end: '' });
            };

            // Issue 43: Delete saved filter
            const deleteSavedFilter = (filterId) => {
                saveSavedFilters(savedFilters.filter(f => f.id !== filterId));
            };

            const clientEntries = selectedClient ? 
                entries.filter(entry => entry.client === selectedClient.name) : [];

            const totalAllHours = filteredEntries.reduce((sum, entry) => {
                const hours = parseFloat(entry.totalHours);
                return sum + (isNaN(hours) ? 0 : hours);
            }, 0);

            // Issue 27: Budget alerts
            const getProjectBudgetStatus = (clientName, projectName, budget) => {
                if (!budget || budget <= 0) return null;
                
                const projectHours = entries
                    .filter(e => e.client === clientName && e.project === projectName)
                    .reduce((sum, e) => sum + parseFloat(e.totalHours || 0), 0);
                
                const percentage = (projectHours / budget) * 100;
                
                if (percentage >= 100) return { status: 'exceeded', percentage, hours: projectHours };
                if (percentage >= 90) return { status: 'warning', percentage, hours: projectHours };
                return { status: 'ok', percentage, hours: projectHours };
            };

            // Issue 55: Toggle section collapse
            const toggleSection = (sectionId) => {
                setCollapsedSections(prev => ({
                    ...prev,
                    [sectionId]: !prev[sectionId]
                }));
            };

            // Reports
            const getClientReport = () => {
                const clientHours = {};
                filteredEntries.forEach(entry => {
                    const clientName = entry.client || 'No Client';
                    if (!clientHours[clientName]) clientHours[clientName] = 0;
                    const hours = parseFloat(entry.totalHours);
                    if (!isNaN(hours)) clientHours[clientName] += hours;
                });
                return Object.entries(clientHours).sort((a, b) => b[1] - a[1]);
            };

            const getProjectReport = () => {
                const projectHours = {};
                filteredEntries.forEach(entry => {
                    const key = `${entry.client || 'No Client'} - ${entry.project || 'No Project'}`;
                    if (!projectHours[key]) projectHours[key] = 0;
                    const hours = parseFloat(entry.totalHours);
                    if (!isNaN(hours)) projectHours[key] += hours;
                });
                return Object.entries(projectHours).sort((a, b) => b[1] - a[1]);
            };

            const themeBackgrounds = {
                default: {
                    background: 'bg-gradient-to-br from-blue-50 to-indigo-100',
                    card: 'bg-white',
                    accent: 'text-blue-600',
                    highlight: 'from-blue-400 to-purple-500'
                },
                ocean: {
                    background: 'bg-gradient-to-br from-cyan-50 to-sky-100',
                    card: 'bg-white',
                    accent: 'text-cyan-600',
                    highlight: 'from-cyan-400 to-blue-500'
                },
                sunrise: {
                    background: 'bg-gradient-to-br from-rose-50 to-amber-100',
                    card: 'bg-white',
                    accent: 'text-rose-600',
                    highlight: 'from-rose-400 to-amber-400'
                },
                forest: {
                    background: 'bg-gradient-to-br from-green-50 to-emerald-100',
                    card: 'bg-white',
                    accent: 'text-emerald-600',
                    highlight: 'from-green-400 to-emerald-500'
                },
                slate: {
                    background: 'bg-gradient-to-br from-slate-100 to-slate-300',
                    card: 'bg-white',
                    accent: 'text-slate-600',
                    highlight: 'from-slate-400 to-gray-500'
                },
                lavender: {
                    background: 'bg-gradient-to-br from-purple-50 to-fuchsia-100',
                    card: 'bg-white',
                    accent: 'text-purple-600',
                    highlight: 'from-purple-400 to-fuchsia-500'
                },
                sunset: {
                    background: 'bg-gradient-to-br from-orange-50 to-pink-100',
                    card: 'bg-white',
                    accent: 'text-orange-600',
                    highlight: 'from-orange-400 to-pink-500'
                }
            };

            const currentTheme = themeBackgrounds[customization.theme] || themeBackgrounds.default;

            const themeClasses = darkMode 
                ? 'bg-gray-900 text-white' 
                : currentTheme.background;

            const cardClasses = darkMode 
                ? 'bg-gray-800 text-white' 
                : currentTheme.card;

            // Navigation Component
            const Navigation = () => (
                <div className={`${cardClasses} rounded-lg shadow-lg p-4 mb-6`}>
                    <div className="flex flex-wrap gap-2">
                        <button
                            onClick={() => setCurrentPage('dashboard')}
                            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition ${
                                currentPage === 'dashboard' 
                                    ? 'bg-blue-600 text-white' 
                                    : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'
                            }`}
                        >
                            <BarChart />
                            Dashboard
                        </button>
                        <button
                            onClick={() => setCurrentPage('clients')}
                            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition ${
                                currentPage === 'clients' 
                                    ? 'bg-blue-600 text-white' 
                                    : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'
                            }`}
                        >
                            <Users />
                            Clients ({clients.length})
                        </button>
                        <button
                            onClick={() => setCurrentPage('settings')}
                            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition ${
                                currentPage === 'settings' 
                                    ? 'bg-blue-600 text-white' 
                                    : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'
                            }`}
                        >
                            <Settings />
                            Settings
                        </button>
                    </div>
                </div>
            );

            const TimerForm = React.memo(({ currentClient, currentProject, currentNotes, clients, darkMode, onChange }) => {
                const availableProjects = useMemo(() => {
                    return clients.find(c => c.name === currentClient)?.projects || [];
                }, [clients, currentClient]);

                return (
                    <div className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-2">Client</label>
                                <select
                                    value={currentClient}
                                    onChange={(e) => onChange('currentClient', e.target.value)}
                                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                >
                                    <option value="">Select Client</option>
                                    {clients.map(client => (
                                        <option key={client.id} value={client.name}>{client.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-2">Project</label>
                                <select
                                    value={currentProject}
                                    onChange={(e) => onChange('currentProject', e.target.value)}
                                    disabled={!currentClient}
                                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} disabled:opacity-50`}
                                >
                                    <option value="">Select Project</option>
                                    {availableProjects.map(project => (
                                        <option key={project.id} value={project.name}>{project.name}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-2">Notes</label>
                            <textarea
                                value={currentNotes}
                                onChange={(e) => onChange('currentNotes', e.target.value)}
                                placeholder="What are you working on?"
                                rows="2"
                                className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                            />
                        </div>
                    </div>
                );
            });

            const ManualEntryModal = ({
                isOpen,
                entry,
                clients,
                darkMode,
                onClose,
                onFieldChange,
                onBreakAdd,
                onBreakChange,
                onBreakRemove,
                onSubmit,
                hoursPreview
            }) => {
                const projectOptions = useMemo(() => {
                    if (!entry?.client) return [];
                    return clients.find(c => c.name === entry.client)?.projects || [];
                }, [clients, entry?.client]);

                if (!isOpen || !entry) {
                    return null;
                }

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start md:items-center justify-center z-50 p-4 overflow-y-auto">
                        <div className={`${cardClasses} rounded-lg shadow-2xl w-full max-w-3xl`}>
                            <div className="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                                <h2 className="text-2xl font-bold flex items-center gap-2">
                                    <FileText />
                                    Manual Entry
                                </h2>
                                <button
                                    onClick={onClose}
                                    className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                >
                                    <X />
                                </button>
                            </div>
                            <form onSubmit={onSubmit} className="p-6 space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Date</label>
                                        <input
                                            type="date"
                                            value={entry.date}
                                            onChange={(e) => onFieldChange('date', e.target.value)}
                                            className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Reminder (minutes)</label>
                                        <input
                                            type="number"
                                            min="5"
                                            value={entry.reminderDuration}
                                            onChange={(e) => onFieldChange('reminderDuration', parseInt(e.target.value) || 0)}
                                            className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Client</label>
                                        <select
                                            value={entry.client}
                                            onChange={(e) => onFieldChange('client', e.target.value)}
                                            className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                        >
                                            <option value="">Select Client</option>
                                            {clients.map(client => (
                                                <option key={client.id} value={client.name}>{client.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Project</label>
                                        <select
                                            value={entry.project}
                                            onChange={(e) => onFieldChange('project', e.target.value)}
                                            disabled={!entry.client}
                                            className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} disabled:opacity-50`}
                                        >
                                            <option value="">Select Project</option>
                                            {projectOptions.map(project => (
                                                <option key={project.id} value={project.name}>{project.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Time Started</label>
                                        <input
                                            type="time"
                                            value={entry.timeStarted}
                                            onChange={(e) => onFieldChange('timeStarted', e.target.value)}
                                            className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Time Done</label>
                                        <input
                                            type="time"
                                            value={entry.timeDone}
                                            onChange={(e) => onFieldChange('timeDone', e.target.value)}
                                            className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                            required
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Notes</label>
                                    <textarea
                                        value={entry.notes}
                                        onChange={(e) => onFieldChange('notes', e.target.value)}
                                        rows="4"
                                        placeholder="What did you work on?"
                                        className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                    />
                                </div>

                                <div>
                                    <div className="flex items-center justify-between mb-2">
                                        <label className="text-sm font-medium">Breaks</label>
                                        <button
                                            type="button"
                                            onClick={onBreakAdd}
                                            className="text-blue-600 hover:text-blue-800 text-sm"
                                        >
                                            + Add Break
                                        </button>
                                    </div>
                                    {entry.breaks.length === 0 ? (
                                        <p className="text-sm text-gray-500 dark:text-gray-400">No breaks added.</p>
                                    ) : (
                                        <div className="space-y-3">
                                            {entry.breaks.map(brk => (
                                                <div key={brk.id} className="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
                                                    <div>
                                                        <label className="block text-xs font-medium mb-1">Duration (minutes)</label>
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            value={brk.duration}
                                                            onChange={(e) => onBreakChange(brk.id, 'duration', parseInt(e.target.value) || 0)}
                                                            className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                                        />
                                                    </div>
                                                    <div className="md:col-span-2">
                                                        <label className="block text-xs font-medium mb-1">Description</label>
                                                        <input
                                                            type="text"
                                                            value={brk.description}
                                                            onChange={(e) => onBreakChange(brk.id, 'description', e.target.value)}
                                                            className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                                            placeholder="Lunch, errand, etc."
                                                        />
                                                    </div>
                                                    <button
                                                        type="button"
                                                        onClick={() => onBreakRemove(brk.id)}
                                                        className="text-red-600 hover:text-red-800 text-sm md:col-span-3 text-left"
                                                    >
                                                        Remove
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Issue 3: Real-time invalid time warning */}
                                {hoursPreview === 'Invalid' && (
                                    <div className="flex items-center gap-2 p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg text-red-600 dark:text-red-400">
                                        <AlertTriangle size={20} />
                                        <span className="text-sm font-medium">Time Done must be after Time Started</span>
                                    </div>
                                )}

                                <div className="flex items-center justify-between rounded-lg border border-dashed border-gray-300 dark:border-gray-600 px-4 py-3">
                                    <div>
                                        <p className="text-sm text-gray-500">Calculated Total</p>
                                        <p className={`text-2xl font-semibold ${hoursPreview === 'Invalid' ? 'text-red-500' : ''}`}>
                                                {hoursPreview && hoursPreview !== 'Invalid'
                                                    ? formatHoursDisplay(hoursPreview)
                                                    : hoursPreview === 'Invalid'
                                                        ? 'Invalid'
                                                        : '0m'}
                                        </p>
                                    </div>
                                    <div className="flex gap-3">
                                        <button
                                            type="button"
                                            onClick={onClose}
                                            className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            disabled={hoursPreview === 'Invalid'}
                                            className={`px-4 py-2 rounded-lg text-white ${hoursPreview === 'Invalid' ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
                                        >
                                            Save Entry
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            };

            // Live Timer Component with Pause and Breaks (Issues 7, 12)
            const LiveTimer = () => {
                const timerBreakMinutes = timer.breaks.reduce((sum, brk) => sum + (parseInt(brk.duration) || 0), 0);
                
                return (
                <div className={`${cardClasses} rounded-lg shadow-lg p-6 mb-6 ${timer.isRunning && !timer.isPaused && customization.highlightTimer ? 'border-2 border-green-500 animate-pulse' : ''} ${timer.isPaused ? 'border-2 border-yellow-500' : ''}`}>
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-2xl font-bold flex items-center gap-2">
                            <Clock />
                            Live Timer 
                            {timer.isRunning && !timer.isPaused && ''}
                            {timer.isPaused && ' PAUSED'}
                        </h2>
                        <div className={`text-3xl font-mono font-bold ${timer.isPaused ? 'text-yellow-600' : 'text-green-600'}`}>
                            {formatTime(timer.elapsedSeconds)}
                        </div>
                    </div>

                    {timer.isRunning ? (
                        <div className="space-y-4">
                            <TimerForm
                                currentClient={timerFormValues.currentClient}
                                currentProject={timerFormValues.currentProject}
                                currentNotes={timerFormValues.currentNotes}
                                clients={clients}
                                darkMode={darkMode}
                                onChange={updateTimerField}
                            />
                            
                            {/* Issue 12: Timer Breaks Section */}
                            <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg p-4`}>
                                <div className="flex items-center justify-between mb-3">
                                    <label className="text-sm font-medium flex items-center gap-2">
                                        <Coffee size={16} /> Breaks ({timerBreakMinutes} min total)
                                    </label>
                                    <button
                                        type="button"
                                        onClick={addTimerBreak}
                                        className="text-blue-600 hover:text-blue-800 text-sm"
                                    >
                                        + Add Break
                                    </button>
                                </div>
                                {timer.breaks.length === 0 ? (
                                    <p className="text-sm text-gray-500 dark:text-gray-400">No breaks tracked yet.</p>
                                ) : (
                                    <div className="space-y-2">
                                        {timer.breaks.map(brk => (
                                            <div key={brk.id} className="flex items-center gap-2">
                                                <input
                                                    type="number"
                                                    min="0"
                                                    value={brk.duration}
                                                    onChange={(e) => updateTimerBreak(brk.id, 'duration', parseInt(e.target.value) || 0)}
                                                    className={`w-20 px-2 py-1 border rounded ${darkMode ? 'bg-gray-600 border-gray-500' : 'bg-white border-gray-300'}`}
                                                    placeholder="Min"
                                                />
                                                <input
                                                    type="text"
                                                    value={brk.description}
                                                    onChange={(e) => updateTimerBreak(brk.id, 'description', e.target.value)}
                                                    className={`flex-1 px-2 py-1 border rounded ${darkMode ? 'bg-gray-600 border-gray-500' : 'bg-white border-gray-300'}`}
                                                    placeholder="Break description..."
                                                />
                                                <button
                                                    onClick={() => removeTimerBreak(brk.id)}
                                                    className="text-red-500 hover:text-red-700 p-1"
                                                >
                                                    <X size={16} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            {/* Timer Control Buttons */}
                            <div className="grid grid-cols-2 gap-3">
                                {timer.isPaused ? (
                                    <button
                                        onClick={resumeTimer}
                                        className="bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg flex items-center justify-center gap-2 font-semibold"
                                    >
                                        <Play /> Resume
                                    </button>
                                ) : (
                                    <button
                                        onClick={pauseTimer}
                                        className="bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded-lg flex items-center justify-center gap-2 font-semibold"
                                    >
                                        <Pause /> Pause
                                    </button>
                                )}
                                <button
                                    onClick={stopTimer}
                                    className="bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg flex items-center justify-center gap-2 font-semibold"
                                >
                                    <Stop /> Stop & Save
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="text-center">
                            <p className="text-gray-600 dark:text-gray-400 mb-4">
                                Ready to track your work time? Start the timer when you begin working.
                            </p>
                            <button
                                onClick={startTimer}
                                className="bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg flex items-center justify-center gap-2 font-semibold mx-auto"
                            >
                                <Play /> Start Timer (Ctrl+T)
                            </button>
                        </div>
                    )}
                </div>
                );
            };

            // Stats Cards Component
            const StatsCards = () => (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    {/* Today's Hours */}
                    <div className={`${cardClasses} rounded-lg shadow-lg p-6 transform hover:scale-105 transition-transform duration-200 cursor-pointer`}>
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Today's Hours</p>
                                <p className={`text-3xl font-bold ${darkMode ? 'text-blue-300' : currentTheme.accent}`}>
                                    {formatHoursDisplay(todayStats.hours)}
                                </p>
                                <p className="text-sm text-gray-500">{todayStats.entries} entries</p>
                            </div>
                            <div className="text-2xl"></div>
                        </div>
                    </div>

                    {/* This Week */}
                    <div className={`${cardClasses} rounded-lg shadow-lg p-6 transform hover:scale-105 transition-transform duration-200 cursor-pointer`}>
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm font-medium text-gray-600 dark:text-gray-400">This Week</p>
                                <p className={`text-3xl font-bold ${darkMode ? 'text-green-300' : 'text-green-600'}`}>
                                    {formatHoursDisplay(weekStats.hours)}
                                </p>
                                <p className="text-sm text-gray-500">{formatHoursDisplay(weekStats.dailyAverage)} avg/day</p>
                                <p className="text-xs text-gray-500">Goal: {formatHoursDisplay(customization.weeklyHourGoal)} / wk</p>
                            </div>
                            <div className="text-2xl"></div>
                        </div>
                    </div>

                    {/* Active Clients */}
                    <div className={`${cardClasses} rounded-lg shadow-lg p-6 transform hover:scale-105 transition-transform duration-200 cursor-pointer`}>
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Active Today</p>
                                <p className={`text-3xl font-bold ${darkMode ? 'text-purple-300' : 'text-purple-600'}`}>
                                    {todayStats.activeClients}
                                </p>
                                <p className="text-sm text-gray-500">clients worked with</p>
                            </div>
                            <div className="text-2xl"></div>
                        </div>
                    </div>

                    {/* Total Entries */}
                    <div className={`${cardClasses} rounded-lg shadow-lg p-6 transform hover:scale-105 transition-transform duration-200 cursor-pointer`}>
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Total Entries</p>
                                <p className="text-3xl font-bold text-orange-600">{entries.length}</p>
                                <p className="text-sm text-gray-500">all-time records</p>
                            </div>
                            <div className="text-2xl"></div>
                        </div>
                    </div>
                </div>
            );

            // Weekly Activity Chart
            const WeeklyChart = () => (
                <div className={`${cardClasses} rounded-lg shadow-lg p-6 mb-6`}>
                    <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                         Weekly Activity
                    </h3>
                    <div className="space-y-3">
                        {weekData.map(day => {
                            const percentage = (day.hours / maxWeekHours) * 100;
                            return (
                                <div key={day.date} className="flex items-center gap-4">
                                    <div className="w-12 text-sm font-medium">
                                        <span className={day.isToday ? 'text-blue-600 font-bold' : ''}>
                                            {day.day}
                                        </span>
                                    </div>
                                    <div className="flex-1">
                                        <div 
                                            className={`h-6 rounded-full transition-all duration-500 ${
                                                day.isToday 
                                                    ? (darkMode ? 'bg-blue-300' : 'bg-blue-500') 
                                                    : `bg-gradient-to-r ${darkMode ? 'from-gray-500 to-gray-700' : currentTheme.highlight}`
                                            }`}
                                            style={{ width: `${Math.max(percentage, 5)}%` }}
                                        ></div>
                                    </div>
                                    <div className="w-16 text-right text-sm font-semibold">
                                        {formatHoursDisplay(day.hours)}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            // Top Clients Leaderboard
            const TopClients = () => (
                <div className={`${cardClasses} rounded-lg shadow-lg p-6 mb-6`}>
                    <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                         Top Clients
                    </h3>
                    <div className="space-y-3">
                        {topClients.map((client, index) => (
                            <div key={client.client} className="flex items-center justify-between p-3 rounded-lg bg-gray-50 dark:bg-gray-700">
                                <div className="flex items-center gap-3">
                                    <div className="text-lg">{client.medal}</div>
                                    <div 
                                        className="w-3 h-3 rounded-full"
                                        style={{ backgroundColor: client.color }}
                                    ></div>
                                    <span className="font-medium">{client.client}</span>
                                </div>
                                <div className="flex items-center gap-3">
                                    <div className="w-24 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                        <div 
                                            className={`h-2 rounded-full transition-all duration-500 ${
                                                darkMode ? 'bg-gradient-to-r from-gray-500 to-gray-700' : `bg-gradient-to-r ${currentTheme.highlight}`
                                            }`}
                                            style={{ 
                                                width: `${(client.hours / Math.max(topClients[0]?.hours || 1, 1)) * 100}%` 
                                            }}
                                        ></div>
                                    </div>
                                    <span className="font-bold text-blue-600 w-16 text-right">
                                        {formatHoursDisplay(client.hours)}
                                    </span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            // Recent Activity Feed
            const RecentActivity = () => (
                <div className={`${cardClasses} rounded-lg shadow-lg p-6 mb-6`}>
                    <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                         Recent Activity
                    </h3>
                    <div className="space-y-3">
                        {recentActivity.map(entry => (
                            <div key={entry.id} className="flex justify-between items-center p-4 border rounded-lg hover:shadow-md transition-shadow">
                                <div>
                                    <p className="font-medium">{entry.client || 'No Client'} - {entry.project || 'No Project'}</p>
                                    <p className="text-sm text-gray-600">
                                        {entry.date}  {formatDisplayTime(entry.timeStarted)} - {formatDisplayTime(entry.timeDone)}
                                    </p>
                                </div>
                        <div className="text-right">
                            <p className={`font-semibold text-lg ${darkMode ? 'text-white' : currentTheme.accent}`}>
                                {formatHoursDisplay(entry.totalHours)}
                            </p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            // Quick Actions Panel
            const QuickActions = () => (
                <div className={`${cardClasses} rounded-lg shadow-lg p-6 mb-6`}>
                    <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                         Quick Actions
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {!timer.isRunning ? (
                            <button
                                onClick={startTimer}
                                className="bg-green-600 hover:bg-green-700 text-white py-4 rounded-lg flex flex-col items-center justify-center gap-2 transition-transform hover:scale-105"
                            >
                                <Play size={24} />
                                <span className="font-semibold">Start Timer</span>
                                <span className="text-sm opacity-90">(Ctrl+T)</span>
                            </button>
                        ) : (
                            <button
                                onClick={stopTimer}
                                className="bg-red-600 hover:bg-red-700 text-white py-4 rounded-lg flex flex-col items-center justify-center gap-2 transition-transform hover:scale-105"
                            >
                                <Stop size={24} />
                                <span className="font-semibold">Stop Timer</span>
                                <span className="text-sm opacity-90">Save Entry</span>
                            </button>
                        )}
                        <button
                            onClick={addEntry}
                            className="bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-lg flex flex-col items-center justify-center gap-2 transition-transform hover:scale-105"
                        >
                            <Plus size={24} />
                            <span className="font-semibold">Manual Entry</span>
                            <span className="text-sm opacity-90">(Ctrl+N)</span>
                        </button>
                        <button
                            onClick={exportToExcel}
                            className="bg-purple-600 hover:bg-purple-700 text-white py-4 rounded-lg flex flex-col items-center justify-center gap-2 transition-transform hover:scale-105"
                        >
                            <Download size={24} />
                            <span className="font-semibold">Export Data</span>
                            <span className="text-sm opacity-90">Excel/JSON</span>
                        </button>
                    </div>
                </div>
            );

            const EntriesSection = () => (
                <div className={`${cardClasses} rounded-lg shadow-lg p-6`}>
                    <div className="flex flex-wrap gap-4 items-end mb-6">
                        <div className="flex-1 min-w-[200px]">
                            <label className="block text-sm font-medium mb-1">Search</label>
                            <input
                                type="text"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                placeholder="Search client, project or notes"
                                className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                            />
                        </div>
                        <div className="w-48">
                            <label className="block text-sm font-medium mb-1">Client</label>
                            <select
                                value={filterClient}
                                onChange={(e) => setFilterClient(e.target.value)}
                                className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                            >
                                <option value="all">All clients</option>
                                {clients.map(client => (
                                    <option key={client.id} value={client.name}>{client.name}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">From</label>
                            <input
                                type="date"
                                value={filterDateRange.start}
                                onChange={(e) => handleDateFilterChange('start', e.target.value)}
                                className={`px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">To</label>
                            <input
                                type="date"
                                value={filterDateRange.end}
                                onChange={(e) => handleDateFilterChange('end', e.target.value)}
                                className={`px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                            />
                        </div>
                        <button
                            onClick={resetFilters}
                            className="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 transition"
                        >
                            Reset
                        </button>
                    </div>

                    {filteredEntries.length === 0 ? (
                        <p className="text-gray-500 dark:text-gray-400">No entries match the current filters.</p>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full text-sm">
                                <thead>
                                    <tr className="text-left text-gray-500 uppercase tracking-wider text-xs">
                                        <th className="py-2 pr-4">Date</th>
                                        <th className="py-2 pr-4">Client</th>
                                        <th className="py-2 pr-4">Project</th>
                                        <th className="py-2 pr-4">Start</th>
                                        <th className="py-2 pr-4">End</th>
                                        <th className="py-2 pr-4">Breaks (min)</th>
                                        <th className="py-2 pr-4">Total</th>
                                        <th className="py-2 pr-4">Notes</th>
                                        <th className="py-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredEntries.map(entry => {
                                        const editable = canEdit(entry.date);
                                        const safeBreaks = ensureArray(entry.breaks);
                                        const breakMinutes = safeBreaks.reduce((sum, brk) => sum + (parseInt(brk.duration || 0)), 0);
                                        return (
                                            <tr key={entry.id} className="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                                                <td className="py-3 pr-4">
                                                    <input
                                                        type="date"
                                                        value={entry.date}
                                                        disabled={!editable}
                                                        onChange={(e) => updateEntry(entry.id, 'date', e.target.value)}
                                                        className={`bg-transparent ${editable ? 'cursor-text' : 'opacity-60'}`}
                                                    />
                                                </td>
                                                <td className="py-3 pr-4">
                                                    <input
                                                        type="text"
                                                        value={entry.client}
                                                        disabled={!editable}
                                                        onChange={(e) => updateEntry(entry.id, 'client', e.target.value)}
                                                        className={`bg-transparent w-40 ${editable ? 'border-b border-dashed focus:outline-none' : 'opacity-60'}`}
                                                        placeholder="Client"
                                                    />
                                                </td>
                                                <td className="py-3 pr-4">
                                                    <input
                                                        type="text"
                                                        value={entry.project}
                                                        disabled={!editable}
                                                        onChange={(e) => updateEntry(entry.id, 'project', e.target.value)}
                                                        className={`bg-transparent w-40 ${editable ? 'border-b border-dashed focus:outline-none' : 'opacity-60'}`}
                                                        placeholder="Project"
                                                    />
                                                </td>
                                                <td className="py-3 pr-4">
                                                    <input
                                                        type="time"
                                                        value={entry.timeStarted}
                                                        disabled={!editable}
                                                        onChange={(e) => updateEntry(entry.id, 'timeStarted', e.target.value)}
                                                        className={`bg-transparent ${editable ? 'cursor-text' : 'opacity-60'}`}
                                                    />
                                                </td>
                                                <td className="py-3 pr-4">
                                                    <input
                                                        type="time"
                                                        value={entry.timeDone}
                                                        disabled={!editable}
                                                        onChange={(e) => updateEntry(entry.id, 'timeDone', e.target.value)}
                                                        className={`bg-transparent ${editable ? 'cursor-text' : 'opacity-60'}`}
                                                    />
                                                </td>
                                                <td className="py-3 pr-4">
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        value={breakMinutes}
                                                        disabled
                                                        className="bg-transparent w-20"
                                                    />
                                                </td>
                                                <td className="py-3 pr-4 font-semibold">
                                                    {formatHoursDisplay(entry.totalHours)}
                                                </td>
                                                <td className="py-3 pr-4">
                                                    <NotesEditor
                                                        entryId={entry.id}
                                                        value={entry.notes}
                                                        disabled={!editable}
                                                    />
                                                </td>
                                                <td className="py-3 space-x-2">
                                                    <button
                                                        onClick={() => setReminder(entry.id, entry.reminderDuration || customization.defaultReminderDuration)}
                                                        disabled={!entry.timeStarted || entry.timeDone}
                                                        className="text-blue-600 hover:underline disabled:text-gray-400"
                                                    >
                                                        Reminder
                                                    </button>
                                                    <button
                                                        onClick={() => deleteEntry(entry.id)}
                                                        className="inline-flex items-center gap-1 text-red-600 hover:underline"
                                                    >
                                                        <Trash2 size={16} /> Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );

            const ClientsPage = () => (
                <div className="space-y-6">
                    <div className={`${cardClasses} rounded-lg shadow-lg p-6`}>
                        <div className="flex flex-wrap items-center justify-between gap-4">
                            <div>
                                <h2 className="text-2xl font-bold flex items-center gap-2">
                                    <Users />
                                    Client Directory
                                </h2>
                                <p className="text-gray-500 dark:text-gray-400">Manage your clients and their projects.</p>
                            </div>
                            <button
                                onClick={addClient}
                                className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2"
                            >
                                <Plus size={18} /> New Client
                            </button>
                        </div>
                    </div>

                    {clients.length === 0 ? (
                        <div className={`${cardClasses} rounded-lg shadow-lg p-6 text-center text-gray-500 dark:text-gray-400`}>
                            No clients yet. Use the "New Client" button to add your first client.
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                            {clients.map(client => (
                                <button
                                    key={client.id}
                                    onClick={() => openClientDetail(client)}
                                    className={`${cardClasses} rounded-lg shadow p-5 border border-gray-100 dark:border-gray-700 text-left transition transform hover:-translate-y-1 hover:shadow-xl`}
                                >
                                    <div className="flex items-center gap-3 mb-3">
                                        <span
                                            className="w-3 h-3 rounded-full"
                                            style={{ backgroundColor: client.color || '#6B7280' }}
                                        ></span>
                                        <div>
                                            <p className="font-semibold text-lg">{client.name}</p>
                                            <p className="text-xs text-gray-500">{client.contact?.email || 'No email'}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center justify-between text-sm text-gray-500">
                                        <span>{client.projects.length} projects</span>
                                        <span>{clientEntries.filter(entry => entry.client === client.name).length} entries</span>
                                    </div>
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            );

            const ClientDetailPage = () => {
                if (!selectedClient) {
                    return (
                        <div className={`${cardClasses} rounded-lg shadow-lg p-6`}>
                            <p className="text-gray-500 dark:text-gray-400 mb-4">No client selected.</p>
                            <button
                                onClick={() => setCurrentPage('clients')}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg"
                            >
                                Back to Clients
                            </button>
                        </div>
                    );
                }

                return (
                    <div className="space-y-6 max-w-6xl mx-auto">
                        <div className="flex items-center gap-2 text-sm text-gray-500">
                            <button
                                className="text-blue-600 hover:underline"
                                onClick={() => setCurrentPage('clients')}
                            >
                                Clients
                            </button>
                            <span>/</span>
                            <span>{selectedClient.name}</span>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className={`${cardClasses} rounded-lg shadow-lg p-6 lg:col-span-2`}>
                                <div className="flex flex-wrap items-center justify-between gap-4 mb-4">
                                    <div>
                                        <h2 className="text-3xl font-bold">{selectedClient.name}</h2>
                                        <p className="text-gray-500 dark:text-gray-400">
                                            {selectedClient.projects.length} projects  {clientEntries.length} entries
                                        </p>
                                    </div>
                                    <button
                                        onClick={() => {
                                            const nextName = prompt('Rename client', selectedClient.name);
                                            if (nextName && nextName.trim()) {
                                                updateClientField(selectedClient.id, 'name', nextName.trim());
                                            }
                                        }}
                                        className="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600"
                                    >
                                        Rename
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600 dark:text-gray-300">
                                    <div>
                                        <p className="font-semibold">Email</p>
                                        <p>{selectedClient.contact.email || ''}</p>
                                    </div>
                                    <div>
                                        <p className="font-semibold">Phone</p>
                                        <p>{selectedClient.contact.phone || ''}</p>
                                    </div>
                                    <div>
                                        <p className="font-semibold">Address</p>
                                        <p>{selectedClient.contact.address || ''}</p>
                                    </div>
                                </div>
                            </div>

                            <div className={`${cardClasses} rounded-lg shadow-lg p-6 space-y-4`}>
                                <h3 className="text-lg font-semibold">Client Settings</h3>
                                <div>
                                    <label className="block text-xs uppercase tracking-wide text-gray-500 mb-1">Color</label>
                                    <input
                                        type="color"
                                        value={selectedClient.color || '#6B7280'}
                                        onChange={(e) => updateClientField(selectedClient.id, 'color', e.target.value)}
                                        className="w-16 h-10 rounded cursor-pointer border border-gray-300 dark:border-gray-600"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs uppercase tracking-wide text-gray-500 mb-1">Hourly Rate</label>
                                    <input
                                        type="number"
                                        min="0"
                                        value={selectedClient.hourlyRate || 0}
                                        onChange={(e) => updateClientField(selectedClient.id, 'hourlyRate', parseFloat(e.target.value) || 0)}
                                        className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs uppercase tracking-wide text-gray-500 mb-1">Contact Notes</label>
                                    <textarea
                                        value={selectedClient.notes || ''}
                                        onChange={(e) => updateClientField(selectedClient.id, 'notes', e.target.value)}
                                        rows="3"
                                        className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                    />
                                </div>
                                <button
                                    onClick={() => deleteClient(selectedClient.id)}
                                    className="w-full px-4 py-2 rounded-lg bg-red-100 text-red-600 hover:bg-red-200"
                                >
                                    Delete Client
                                </button>
                            </div>
                        </div>

                        <div className={`${cardClasses} rounded-lg shadow-lg p-6`}>
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-xl font-semibold">Projects</h3>
                                <button
                                    type="button"
                                    onClick={() => addProjectToClient(selectedClient.id)}
                                    className="text-blue-600 hover:text-blue-800 text-sm"
                                >
                                    + Add Project
                                </button>
                            </div>
                            {selectedClient.projects.length === 0 ? (
                                <p className="text-gray-500">No projects yet.</p>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {selectedClient.projects.map(project => (
                                        <div key={project.id} className="border border-gray-100 dark:border-gray-700 rounded-lg p-4 space-y-4">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="font-semibold">{project.name}</p>
                                                    <p className="text-xs text-gray-500">{project.notes || 'No notes'}</p>
                                                </div>
                                                <span className="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700">
                                                    Budget: {project.budget || 0} hrs
                                                </span>
                                            </div>
                                            <textarea
                                                value={project.notes || ''}
                                                onChange={(e) => updateClientProjectField(selectedClient.id, project.id, { notes: e.target.value })}
                                                rows="2"
                                                className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                                placeholder="Update project notes..."
                                            />
                                            <div className="flex flex-wrap gap-2">
                                                <button
                                                    type="button"
                                                    onClick={() => openNotesModal(selectedClient.name, project.name)}
                                                    className="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm dark:bg-gray-700 dark:hover:bg-gray-600"
                                                >
                                                    Notes Panel
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => removeProjectFromClient(selectedClient.id, project.id)}
                                                    className="px-3 py-1 rounded bg-red-100 text-red-600 hover:bg-red-200 text-sm"
                                                >
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        <div className={`${cardClasses} rounded-lg shadow-lg p-6`}>
                            <h3 className="text-xl font-semibold mb-4">Recent Activity</h3>
                            {clientEntries.length === 0 ? (
                                <p className="text-gray-500">No entries recorded for this client.</p>
                            ) : (
                                <div className="space-y-3">
                                    {clientEntries.slice(0, 10).map(entry => (
                                        <div key={entry.id} className="p-4 border rounded-lg flex justify-between">
                                            <div>
                                                <p className="font-semibold">{entry.project || 'No Project'}</p>
                                                <p className="text-sm text-gray-500">
                                                    {entry.date}  {formatDisplayTime(entry.timeStarted)} - {formatDisplayTime(entry.timeDone)}
                                                </p>
                                            </div>
                                            <div className="text-right font-semibold">{formatHoursDisplay(entry.totalHours)}</div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const SettingsPage = () => (
                <div className="space-y-6">
                    <div className={`${cardClasses} rounded-lg shadow-lg p-6`}>
                        <h2 className="text-2xl font-bold mb-4 flex items-center gap-2">
                            <Settings />
                            Appearance & Behavior
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label className="block text-sm font-medium mb-1">Accent Theme</label>
                                <select
                                    value={customization.theme}
                                    onChange={(e) => updateCustomization('theme', e.target.value)}
                                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                >
                                    <option value="default">Indigo</option>
                                    <option value="ocean">Ocean</option>
                                    <option value="sunrise">Sunrise</option>
                                    <option value="forest">Forest</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Mode</label>
                                <button
                                    onClick={() => saveDarkMode(!darkMode)}
                                    className="w-full px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600"
                                >
                                    Switch to {darkMode ? 'Light' : 'Dark'} Mode
                                </button>
                            </div>
                            <div className="flex items-center">
                                <label className="flex items-center gap-3 text-sm font-medium">
                                    <input
                                        type="checkbox"
                                        checked={customization.enableTooltips}
                                        onChange={(e) => updateCustomization('enableTooltips', e.target.checked)}
                                    />
                                    Show contextual tooltips
                                </label>
                            </div>
                            {/* Issue 86: Date Format */}
                            <div>
                                <label className="block text-sm font-medium mb-1">Date Format</label>
                                <select
                                    value={customization.dateFormat}
                                    onChange={(e) => updateCustomization('dateFormat', e.target.value)}
                                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                >
                                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                </select>
                            </div>
                            {/* Issue 87: First Day of Week */}
                            <div>
                                <label className="block text-sm font-medium mb-1">First Day of Week</label>
                                <select
                                    value={customization.firstDayOfWeek}
                                    onChange={(e) => updateCustomization('firstDayOfWeek', e.target.value)}
                                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                >
                                    <option value="monday">Monday</option>
                                    <option value="sunday">Sunday</option>
                                </select>
                            </div>
                            {/* Issue 51: Items per page */}
                            <div>
                                <label className="block text-sm font-medium mb-1">Items Per Page</label>
                                <select
                                    value={customization.itemsPerPage}
                                    onChange={(e) => updateCustomization('itemsPerPage', parseInt(e.target.value))}
                                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                >
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div className={`${cardClasses} rounded-lg shadow-lg p-6`}>
                        <h2 className="text-2xl font-bold mb-4 flex items-center gap-2">
                            <Clock />
                            Time Tracking Defaults
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label className="block text-sm font-medium mb-1">Default Reminder (minutes)</label>
                                <input
                                    type="number"
                                    min="5"
                                    value={customization.defaultReminderDuration}
                                    onChange={(e) => updateCustomization('defaultReminderDuration', parseInt(e.target.value) || 0)}
                                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Time Format</label>
                                <select
                                    value={customization.timeFormat}
                                    onChange={(e) => updateCustomization('timeFormat', e.target.value)}
                                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                >
                                    <option value="24h">24-hour</option>
                                    <option value="12h">12-hour</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Weekly Hour Goal</label>
                                <input
                                    type="number"
                                    min="1"
                                    value={customization.weeklyHourGoal}
                                    onChange={(e) => updateCustomization('weeklyHourGoal', parseFloat(e.target.value) || 0)}
                                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Default View</label>
                                <select
                                    value={customization.defaultView}
                                    onChange={(e) => {
                                        updateCustomization('defaultView', e.target.value);
                                        setCurrentPage(e.target.value);
                                    }}
                                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                >
                                    <option value="dashboard">Dashboard</option>
                                    <option value="clients">Clients</option>
                                </select>
                            </div>
                            <div className="flex items-center">
                                <label className="flex items-center gap-3 text-sm font-medium">
                                    <input
                                        type="checkbox"
                                        checked={customization.autoSave}
                                        onChange={(e) => updateCustomization('autoSave', e.target.checked)}
                                    />
                                    Auto-save entries as you type
                                </label>
                            </div>
                            <div className="flex items-center">
                                <label className="flex items-center gap-3 text-sm font-medium">
                                    <input
                                        type="checkbox"
                                        checked={customization.confirmDeletions}
                                        onChange={(e) => updateCustomization('confirmDeletions', e.target.checked)}
                                    />
                                    Ask before deleting items
                                </label>
                            </div>
                        </div>
                    </div>

                    {/* Issue 11, 13, 63: Timer Settings */}
                    <div className={`${cardClasses} rounded-lg shadow-lg p-6`}>
                        <h2 className="text-2xl font-bold mb-4 flex items-center gap-2">
                            <Clock />
                            Timer Settings
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="flex items-center">
                                <label className="flex items-center gap-3 text-sm font-medium">
                                    <input
                                        type="checkbox"
                                        checked={customization.highlightTimer}
                                        onChange={(e) => updateCustomization('highlightTimer', e.target.checked)}
                                    />
                                    Highlight timer when running
                                </label>
                            </div>
                            <div className="flex items-center">
                                <label className="flex items-center gap-3 text-sm font-medium">
                                    <input
                                        type="checkbox"
                                        checked={customization.autoStopTimer}
                                        onChange={(e) => updateCustomization('autoStopTimer', e.target.checked)}
                                    />
                                    Auto-stop timer after
                                    <input
                                        type="number"
                                        min="1"
                                        max="24"
                                        value={customization.autoStopHours}
                                        onChange={(e) => updateCustomization('autoStopHours', parseInt(e.target.value) || 8)}
                                        className={`w-16 px-2 py-1 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                        disabled={!customization.autoStopTimer}
                                    />
                                    hours
                                </label>
                            </div>
                            <div className="flex items-center">
                                <label className="flex items-center gap-3 text-sm font-medium">
                                    <input
                                        type="checkbox"
                                        checked={customization.idleDetection}
                                        onChange={(e) => updateCustomization('idleDetection', e.target.checked)}
                                    />
                                    Idle detection after
                                    <input
                                        type="number"
                                        min="5"
                                        max="60"
                                        value={customization.idleThresholdMinutes}
                                        onChange={(e) => updateCustomization('idleThresholdMinutes', parseInt(e.target.value) || 15)}
                                        className={`w-16 px-2 py-1 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                        disabled={!customization.idleDetection}
                                    />
                                    minutes
                                </label>
                            </div>
                            <div className="flex items-center">
                                <label className="flex items-center gap-3 text-sm font-medium">
                                    <input
                                        type="checkbox"
                                        checked={customization.breakReminderEnabled}
                                        onChange={(e) => updateCustomization('breakReminderEnabled', e.target.checked)}
                                    />
                                    Break reminders every
                                    <input
                                        type="number"
                                        min="15"
                                        max="120"
                                        value={customization.breakReminderMinutes}
                                        onChange={(e) => updateCustomization('breakReminderMinutes', parseInt(e.target.value) || 60)}
                                        className={`w-16 px-2 py-1 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                        disabled={!customization.breakReminderEnabled}
                                    />
                                    minutes
                                </label>
                            </div>
                        </div>
                    </div>

                    <div className={`${cardClasses} rounded-lg shadow-lg p-6`}>
                        <h2 className="text-2xl font-bold mb-4 flex items-center gap-2">
                            <Bell />
                            Data & Notifications
                        </h2>
                        <div className="flex flex-wrap gap-4 mb-4">
                            <button
                                onClick={requestNotificationPermission}
                                className="px-4 py-2 rounded-lg bg-amber-500 hover:bg-amber-600 text-white flex items-center gap-2"
                            >
                                <Bell /> Enable Desktop Notifications
                            </button>
                            <button
                                onClick={exportToJSON}
                                className="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white flex items-center gap-2"
                            >
                                <Download /> Export Backup
                            </button>
                            <button
                                onClick={importFromJSON}
                                className="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white flex items-center gap-2"
                            >
                                <Upload /> Import Backup
                            </button>
                            <button
                                onClick={exportToCSV}
                                className="px-4 py-2 rounded-lg bg-teal-600 hover:bg-teal-700 text-white flex items-center gap-2"
                            >
                                <Download /> Export CSV
                            </button>
                            <button
                                onClick={exportToPDF}
                                className="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white flex items-center gap-2"
                            >
                                <Download /> Export PDF
                            </button>
                        </div>
                        <button
                            onClick={clearAllData}
                            className="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white"
                        >
                            Clear Saved Timesheet Data
                        </button>
                    </div>
                </div>
            );

            const manualEntryHoursPreview = manualEntryData
                ? calculateTotalHours(manualEntryData.timeStarted, manualEntryData.breaks, manualEntryData.timeDone)
                : '';

            // Main Dashboard Layout
            const DashboardPage = () => (
                <div className="space-y-6">
                    {/* Live Timer */}
                    <LiveTimer />

                    {/* Quick Actions */}
                    <QuickActions />

                    {/* Stats Cards */}
                    <StatsCards />

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Weekly Chart */}
                        <WeeklyChart />

                        {/* Top Clients & Recent Activity Stack */}
                        <div className="space-y-6">
                            <TopClients />
                            <RecentActivity />
                        </div>
                    </div>

                    <EntriesSection />
                </div>
            );

            // Note: The rest of the component (ClientDetailPage, ClientsPage, SettingsPage, etc.)
            // remains exactly the same as in the previous implementation...

            return (
                <div className={`min-h-screen ${themeClasses} p-6 transition-colors duration-300`}>
                    {/* Issue 102: Toast notifications */}
                    {toast && (
                        <Toast 
                            message={toast.message} 
                            type={toast.type} 
                            onClose={() => setToast(null)} 
                        />
                    )}
                    
                    {/* Issue 57: Loading spinner */}
                    {loading && (
                        <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
                            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 flex items-center gap-3">
                                <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                                <span>Loading...</span>
                            </div>
                        </div>
                    )}
                    
                    {/* Issue 13: Idle warning */}
                    {showIdleWarning && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className={`${cardClasses} rounded-lg shadow-xl p-6 max-w-md mx-4`}>
                                <h3 className="text-xl font-bold mb-2 flex items-center gap-2">
                                    <AlertTriangle className="text-yellow-500" /> Timer Still Running
                                </h3>
                                <p className="text-gray-600 dark:text-gray-400 mb-4">
                                    No activity detected for {customization.idleThresholdMinutes} minutes. 
                                    Is the timer still running intentionally?
                                </p>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowIdleWarning(false)}
                                        className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
                                    >
                                        Continue Timer
                                    </button>
                                    <button
                                        onClick={() => { setShowIdleWarning(false); stopTimer(); }}
                                        className="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg"
                                    >
                                        Stop Timer
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {tooltip.show && (
                        <div 
                            className="fixed bg-gray-900 text-white px-3 py-2 rounded text-sm z-50"
                            style={{ left: tooltip.x + 10, top: tooltip.y + 10 }}
                        >
                            {tooltip.text}
                        </div>
                    )}

                    {/* Notes Modal */}
                    {showNotesModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`${cardClasses} rounded-lg shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden`}>
                                <div className="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                                    <h2 className="text-2xl font-bold flex items-center gap-2">
                                        <StickyNote />
                                        Project Notes
                                    </h2>
                                    <button
                                        onClick={closeNotesModal}
                                        className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition"
                                    >
                                        <X />
                                    </button>
                                </div>
                                <div className="p-6">
                                    <div className="mb-4">
                                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                            {currentNoteKey.split(':::')[0]} - {currentNoteKey.split(':::')[1] || 'No Project'}
                                        </p>
                                    </div>
                                    <textarea
                                        value={currentNoteText}
                                        onChange={(e) => setCurrentNoteText(e.target.value)}
                                        placeholder="Add detailed notes about this project..."
                                        rows="12"
                                        className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'}`}
                                    />
                                    <div className="flex justify-end gap-3 mt-6">
                                        <button
                                            onClick={closeNotesModal}
                                            className={`px-6 py-2 rounded-lg transition ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={saveNote}
                                            className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition"
                                        >
                                            Save Note
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <ManualEntryModal
                        isOpen={showManualEntryModal}
                        entry={manualEntryData}
                        clients={clients}
                        darkMode={darkMode}
                        onClose={closeManualEntry}
                        onFieldChange={updateManualEntryField}
                        onBreakAdd={addManualEntryBreak}
                        onBreakChange={updateManualEntryBreak}
                        onBreakRemove={removeManualEntryBreak}
                        onSubmit={handleManualEntrySubmit}
                        hoursPreview={
                            manualEntryHoursPreview && manualEntryHoursPreview !== 'Invalid'
                                ? manualEntryHoursPreview
                                : manualEntryHoursPreview === 'Invalid'
                                    ? 'Invalid'
                                    : '0.00'
                        }
                    />

                    <div className="max-w-7xl mx-auto">
                        <Navigation />
                        
                        {currentPage === 'dashboard' && <DashboardPage />}
                        {currentPage === 'clients' && <ClientsPage />}
                        {currentPage === 'client-detail' && <ClientDetailPage />}
                        {currentPage === 'settings' && <SettingsPage />}
                        
                        {/* Version footer */}
                        <div className="text-center text-sm text-gray-500 mt-8 pb-4">
                            Timesheet Tracker Pro v{APP_VERSION}
                        </div>
                    </div>
                </div>
            );
        }

        // Wrap with ErrorBoundary (Issue 103)
        ReactDOM.render(
            <ErrorBoundary>
                <TimesheetTracker />
            </ErrorBoundary>, 
            document.getElementById('root')
        );
    </script>
    <style>
        .dark-mode {
            background: #1a202c;
            color: white;
        }
        kbd {
            font-family: monospace;
            font-size: 0.9em;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8); }
        }
        .animate-pulse {
            animation: pulse-glow 2s infinite;
        }
        @keyframes slide-up {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up {
            animation: slide-up 0.3s ease-out;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</body>
</html> 